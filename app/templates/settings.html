{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ìë™ ê±°ë˜ ë´‡ ì„¤ì •</h2>
</div>

<div class="row mt-4">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ê±°ë˜ ì„¤ì •</h5>
                <small class="text-muted">ì „ëµë³„ ìƒì„¸ ì„¤ì •ì€ ì•„ë˜ì—ì„œ í™•ì¸í•˜ì„¸ìš”</small>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.settings') }}" id="settingsForm">
                    {{ form.hidden_tag() }}

                    <!-- ê¸°ë³¸ ì„¤ì • -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            {{ form.ticker.label(class="form-label") }}
                            {{ form.ticker(class="form-select") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.strategy.label(class="form-label") }}
                            {{ form.strategy(class="form-select") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.interval.label(class="form-label") }}
                            {{ form.interval(class="form-select") }}
                        </div>
                    </div>

                    <!-- ê³µí†µ ì„¤ì • - 3ì¤„ë¡œ ì¬êµ¬ì„± -->
                    <h6 class="mt-4 mb-3">ê³µí†µ ì„¤ì •</h6>

                    <!-- ì²« ë²ˆì§¸ ì¤„: ë§¤ìˆ˜ê¸ˆì•¡, ì£¼ë¬¸ê°€ëŠ¥ê¸ˆì•¡ (2ê°œë§Œ) -->
                    <div class="row mb-3">
                        <div class="col-md-6 col-12 mb-3">
                            {{ form.buy_amount.label(class="form-label") }}
                            <!-- í”„ë¦¬ì…‹ ë²„íŠ¼ë“¤ -->
                            <div class="preset-buttons mb-2">
                                <div class="btn-group-sm d-flex flex-wrap gap-1" role="group">
                                    <button type="button" class="btn btn-outline-secondary preset-btn" data-target="buy_amount_input" data-value="10000">1ë§Œì›</button>
                                    <button type="button" class="btn btn-outline-secondary preset-btn" data-target="buy_amount_input" data-value="30000">3ë§Œì›</button>
                                    <button type="button" class="btn btn-outline-secondary preset-btn" data-target="buy_amount_input" data-value="50000">5ë§Œì›</button>
                                    <button type="button" class="btn btn-outline-secondary preset-btn" data-target="buy_amount_input" data-value="100000">10ë§Œì›</button>
                                    <button type="button" class="btn btn-outline-secondary preset-btn" data-target="buy_amount_input" data-value="500000">50ë§Œì›</button>
                                    <button type="button" class="btn btn-outline-secondary preset-btn" data-target="buy_amount_input" data-value="1000000">100ë§Œì›</button>
                                    <button type="button" class="btn btn-outline-secondary preset-btn" data-target="buy_amount_input" data-value="5000000">500ë§Œì›</button>
                                    <button type="button" class="btn btn-outline-secondary preset-btn" data-target="buy_amount_input" data-value="10000000">1000ë§Œì›</button>
                                </div>
                            </div>
                            <!-- ì§ì ‘ ì…ë ¥ í•„ë“œ -->
                            <div class="input-group">
                                {{ form.buy_amount(class="form-control currency-input", id="buy_amount_input", placeholder="ì§ì ‘ ì…ë ¥", step="1000") }}
                                <span class="input-group-text">ì›</span>
                            </div>
                            <small class="text-muted">ìµœì†Œ 5,000ì› ì´ìƒ</small>
                        </div>

                        <div class="col-md-6 col-12 mb-3">
                            {{ form.max_order_amount.label(class="form-label") }}
                            <!-- í”„ë¦¬ì…‹ ë²„íŠ¼ë“¤ (í° ê¸ˆì•¡ìš©) -->
                            <div class="preset-buttons mb-2">
                                <div class="btn-group-sm d-flex flex-wrap gap-1" role="group">
                                    <button type="button" class="btn btn-outline-info preset-btn" data-target="max_order_amount_input" data-value="10000">1ë§Œì›</button>
                                    <button type="button" class="btn btn-outline-info preset-btn" data-target="max_order_amount_input" data-value="50000">5ë§Œì›</button>
                                    <button type="button" class="btn btn-outline-info preset-btn" data-target="max_order_amount_input" data-value="500000">10ë§Œì›</button>
                                    <button type="button" class="btn btn-outline-info preset-btn" data-target="max_order_amount_input" data-value="1000000">100ë§Œì›</button>
                                    <button type="button" class="btn btn-outline-info preset-btn" data-target="max_order_amount_input" data-value="5000000">500ë§Œì›</button>
                                    <button type="button" class="btn btn-outline-info preset-btn" data-target="max_order_amount_input" data-value="10000000">1ì²œë§Œì›</button>
                                    <button type="button" class="btn btn-outline-info preset-btn" data-target="max_order_amount_input" data-value="50000000">5ì²œë§Œì›</button>
                                    <button type="button" class="btn btn-outline-info preset-btn" data-target="max_order_amount_input" data-value="100000000">1ì–µì›</button>
                                </div>
                            </div>
                            <!-- ì§ì ‘ ì…ë ¥ í•„ë“œ -->
                            <div class="input-group">
                                {{ form.max_order_amount(class="form-control currency-input", id="max_order_amount_input", placeholder="ì§ì ‘ ì…ë ¥", step="1000") }}
                                <span class="input-group-text">ì›</span>
                            </div>
                            <small class="text-muted">ì½”ì¸ë‹¹ ìµœëŒ€ íˆ¬ì í•œë„(ì…ë ¥ëœ ê¸ˆì•¡ê¹Œì§€ë§Œ íˆ¬ì ê°€ëŠ¥/0ì›ì´ë©´ ë³´ìœ í˜„ê¸ˆí•œë„ì—ì„œ íˆ¬ì)</small>
                        </div>
                    </div>

                    <!-- ë‘ ë²ˆì§¸ ì¤„: ìµœì†Œë³´ìœ í˜„ê¸ˆëŸ‰, ê±°ë˜ê°„ê²©, ë§¤ë„ ë¹„ìœ¨ -->
                    <div class="row mb-3">
                        <div class="col-md-4 col-12 mb-3">
                            {{ form.min_cash.label(class="form-label") }}
                            <div class="mobile-slider-container">
                                <input type="range" class="form-range mobile-slider"
                                       id="min_cash_slider"
                                       min="0" max="2000000" step="1000"
                                       value="{{ form.min_cash.data or 50000 }}">
                                <div class="slider-value-display">
                                    <span id="min_cash_display">{{ "{:,}".format(form.min_cash.data or 50000) }}ì›</span>
                                </div>
                            </div>
                            {{ form.min_cash(class="form-control d-none", id="min_cash_input") }}
                            <small class="text-muted">ì•ˆì „ ìê¸ˆ(íˆ¬ì í›„ ë³´ìœ í•  ìµœì†Œ ìê¸ˆ)</small>
                        </div>
                        <div class="col-md-4 col-12 mb-3">
                            {{ form.sleep_time.label(class="form-label") }}
                            <div class="mobile-slider-container">
                                <input type="range" class="form-range mobile-slider"
                                       id="sleep_time_slider"
                                       min="10" max="600" step="10"
                                       value="{{ form.sleep_time.data or 60 }}">
                                <div class="slider-value-display">
                                    <span id="sleep_time_display">{{ form.sleep_time.data or 60 }}ì´ˆ</span>
                                </div>
                            </div>
                            {{ form.sleep_time(class="form-control d-none", id="sleep_time_input") }}
                            <small class="text-muted">ë§¤ìˆ˜/ë§¤ë„ ì‹ í˜¸ ê°„ê²©(ë¶„/ì´ˆ)</small>
                        </div>
                        <div class="col-md-4 col-12 mb-3">
                            {{ form.sell_portion.label(class="form-label") }}
                            <div class="mobile-slider-container">
                                <input type="range" class="form-range mobile-slider"
                                       id="sell_portion_slider"
                                       min="0.1" max="1.0" step="0.1"
                                       value="{{ form.sell_portion.data or 0.5 }}">
                                <div class="slider-value-display">
                                    <span id="sell_portion_display">{{ "{:.0%}".format(form.sell_portion.data or 0.5) }}</span>
                                </div>
                            </div>
                            {{ form.sell_portion(class="form-control d-none", id="sell_portion_input") }}
                            <small class="text-muted">ë§¤ë„ ë¹„ìœ¨</small>
                        </div>
                    </div>

                    <!-- ì„¸ ë²ˆì§¸ ì¤„: ì†ì ˆê¸ˆì§€, ì¥ê¸°íˆ¬ì -->
                    <div class="row mb-3">
                        <div class="col-md-6 col-12 mb-3">
                            {{ form.prevent_loss_sale.label(class="form-label") }}
                            {{ form.prevent_loss_sale(class="form-select") }}
                            <small class="text-muted">ë§¤ìˆ˜ í‰ë‹¨ê°€ ì´í•˜ ë§¤ë„ ê¸ˆì§€</small>
                        </div>
                        <div class="col-md-6 col-12 mb-3">
                            {{ form.long_term_investment.label(class="form-label") }}
                            {{ form.long_term_investment(class="form-select") }}
                            <small class="text-muted">ì¥ê¸° íˆ¬ì(ë³´ìœ )ë¥¼ ìœ„í•´ ë§¤ë„ ê¸ˆì§€</small>
                        </div>
                    </div>

                    <!-- ë³¼ë¦°ì € ë°´ë“œ ì „ëµ ì„¤ì • -->
                    <div id="bollinger-settings" class="strategy-settings">
                        <h6 class="mt-4 mb-3">ğŸ“Š ë³¼ë¦°ì € ë°´ë“œ ì „ëµ ì„¤ì •</h6>
                        <div class="alert alert-info">
                            <small><strong>ì„¤ëª…:</strong> ê°€ê²©ì´ ë³¼ë¦°ì € ë°´ë“œ ìƒë‹¨ì„ ëŒíŒŒí•˜ë©´ ë§¤ë„, í•˜ë‹¨ì„ ëŒíŒŒí•˜ë©´ ë§¤ìˆ˜í•˜ëŠ” ì „ëµ</small>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.window.label(class="form-label") }}
                                {{ form.window(class="form-control") }}
                                <small class="text-muted">ì´ë™í‰ê·  ê³„ì‚° ê¸°ê°„</small>
                            </div>
                            <div class="col-md-6">
                                {{ form.multiplier.label(class="form-label") }}
                                {{ form.multiplier(class="form-select") }}
                                <small class="text-muted">ë°´ë“œ í­ ì¡°ì ˆ</small>
                            </div>
                        </div>
                    </div>

                    <!-- ë¹„ëŒ€ì¹­ ë³¼ë¦°ì € ë°´ë“œ ì „ëµ ì„¤ì • -->
                    <div id="bollinger_asymmetric-settings" class="strategy-settings" style="display: none;">
                        <h6 class="mt-4 mb-3">âš–ï¸ ë¹„ëŒ€ì¹­ ë³¼ë¦°ì € ë°´ë“œ ì „ëµ ì„¤ì •</h6>
                        <div class="alert alert-warning">
                            <small><strong>ì„¤ëª…:</strong> ë§¤ìˆ˜ì™€ ë§¤ë„ì— ì„œë¡œ ë‹¤ë¥¸ ìŠ¹ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ë³¼ë¦°ì € ë°´ë“œ ì „ëµ</small>
                            <br>
                            <small>â€¢ <strong>ë§¤ìˆ˜:</strong> ê°€ê²©ì´ 3.0Ïƒ í•˜ë‹¨ë°´ë“œ ì•„ë˜ë¡œ ë–¨ì–´ì§€ë©´ ë§¤ìˆ˜ ì‹ í˜¸</small>
                            <br>
                            <small>â€¢ <strong>ë§¤ë„:</strong> ê°€ê²©ì´ 2.0Ïƒ ìƒë‹¨ë°´ë“œ ìœ„ë¡œ ì˜¬ë¼ê°€ë©´ ë§¤ë„ ì‹ í˜¸</small>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                {{ form.window.label(class="form-label") }}
                                {{ form.window(class="form-control") }}
                                <small class="text-muted">ì´ë™í‰ê·  ê³„ì‚° ê¸°ê°„</small>
                            </div>
                            <div class="col-md-4">
                                {{ form.buy_multiplier.label(class="form-label") }}
                                {{ form.buy_multiplier(class="form-select") }}
                                <small class="text-muted">ë§¤ìˆ˜ ì‹ í˜¸ìš© ìŠ¹ìˆ˜ (í•˜ë‹¨ë°´ë“œ)</small>
                            </div>
                            <div class="col-md-4">
                                {{ form.sell_multiplier.label(class="form-label") }}
                                {{ form.sell_multiplier(class="form-select") }}
                                <small class="text-muted">ë§¤ë„ ì‹ í˜¸ìš© ìŠ¹ìˆ˜ (ìƒë‹¨ë°´ë“œ)</small>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <small><strong>ğŸ’¡ ì „ëµ íŠ¹ì§•:</strong></small>
                            <ul class="list-unstyled mt-2 mb-0">
                                <li>â€¢ ë” ë„“ì€ ë§¤ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì €ì ì—ì„œ ë§¤ìˆ˜ ê¸°íšŒ ì¦ê°€</li>
                                <li>â€¢ ë” ì¢ì€ ë§¤ë„ ê¸°ì¤€ìœ¼ë¡œ ë¹ ë¥¸ ìˆ˜ìµ ì‹¤í˜„</li>
                                <li>â€¢ ë³€ë™ì„±ì´ í° ì‹œì¥ì—ì„œ íš¨ê³¼ì </li>
                                <li>â€¢ ê¸°ë³¸ ì„¤ì •: ë§¤ìˆ˜ 3.0Ïƒ / ë§¤ë„ 2.0Ïƒ</li>
                            </ul>
                        </div>
                    </div>

                    <!-- ë³€ë™ì„± ëŒíŒŒ ì „ëµ ì„¤ì • -->
                    <div id="volatility-settings" class="strategy-settings" style="display: none;">
                        <h6 class="mt-4 mb-3">ğŸš€ ë³€ë™ì„± ëŒíŒŒ ì „ëµ ì„¤ì •</h6>
                        <div class="alert alert-info">
                            <small><strong>ì„¤ëª…:</strong> ë‹¹ì¼ ì‹œê°€ + (ì „ì¼ ë³€ë™í­ Ã— k) ë¥¼ ëŒíŒŒí•˜ë©´ ë§¤ìˆ˜í•˜ëŠ” ì „ëµ</small>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                {{ form.k.label(class="form-label") }}
                                {{ form.k(class="form-control") }}
                                <small class="text-muted">0.3~0.7 ê¶Œì¥</small>
                            </div>
                            <div class="col-md-4">
                                {{ form.target_profit.label(class="form-label") }}
                                {{ form.target_profit(class="form-control") }}
                                <small class="text-muted">ìµì ˆ ê¸°ì¤€</small>
                            </div>
                            <div class="col-md-4">
                                {{ form.stop_loss.label(class="form-label") }}
                                {{ form.stop_loss(class="form-control") }}
                                <small class="text-muted">ì†ì ˆ ê¸°ì¤€</small>
                            </div>
                        </div>
                    </div>

                    <!-- RSI ì „ëµ ì„¤ì • -->
                    <div id="rsi-settings" class="strategy-settings" style="display: none;">
                        <h6 class="mt-4 mb-3">ğŸ“ˆ RSI ì „ëµ ì„¤ì •</h6>
                        <div class="alert alert-info">
                            <small><strong>ì„¤ëª…:</strong> RSI ì§€í‘œë¥¼ ì´ìš©í•˜ì—¬ ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„ êµ¬ê°„ì—ì„œ ë§¤ë§¤í•˜ëŠ” ì „ëµ</small>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-3">
                                {{ form.rsi_period.label(class="form-label") }}
                                {{ form.rsi_period(class="form-control") }}
                                <small class="text-muted">RSI ê³„ì‚° ê¸°ê°„</small>
                            </div>
                            <div class="col-md-3">
                                {{ form.rsi_oversold.label(class="form-label") }}
                                {{ form.rsi_oversold(class="form-control") }}
                                <small class="text-muted">ê³¼ë§¤ë„ ê¸°ì¤€</small>
                            </div>
                            <div class="col-md-3">
                                {{ form.rsi_overbought.label(class="form-label") }}
                                {{ form.rsi_overbought(class="form-control") }}
                                <small class="text-muted">ê³¼ë§¤ìˆ˜ ê¸°ì¤€</small>
                            </div>
                            <div class="col-md-3">
                                {{ form.rsi_timeframe.label(class="form-label") }}
                                {{ form.rsi_timeframe(class="form-select") }}
                                <small class="text-muted">ë¶„ì„ ì‹œê°„ëŒ€</small>
                            </div>
                        </div>
                    </div>

                    <!-- ì–´ëŒ‘í‹°ë¸Œ ì „ëµ ì„¤ì • -->
                    <div id="adaptive-settings" class="strategy-settings" style="display: none;">
                        <h6 class="mt-4 mb-3">ğŸ¯ ì–´ëŒ‘í‹°ë¸Œ ì „ëµ ì„¤ì •</h6>
                        <div class="alert alert-success">
                            <small><strong>ì„¤ëª…:</strong> ì‹œì¥ ìƒí™©(ì¶”ì„¸/íš¡ë³´/ê³ ë³€ë™ì„±)ê³¼ ì‹œê°„ëŒ€ë¥¼ ìë™ ê°ì§€í•˜ì—¬ ìµœì ì˜ ì „ëµì„ ì„ íƒ</small>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <h6>ìë™ ì ìš© ì „ëµ:</h6>
                                <ul class="list-unstyled">
                                    <li>ğŸŒ… <strong>ì˜¤ì „ 9-12ì‹œ:</strong> ë³€ë™ì„± ëŒíŒŒ ì „ëµ</li>
                                    <li>ğŸ½ï¸ <strong>ì ì‹¬ 12-14ì‹œ:</strong> RSI ì „ëµ (ë³´ìˆ˜ì )</li>
                                    <li>ğŸŒ‡ <strong>ì˜¤í›„ 14-18ì‹œ:</strong> ë³¼ë¦°ì € ë°´ë“œ ì „ëµ</li>
                                    <li>ğŸŒƒ <strong>ì €ë… 18-22ì‹œ:</strong> ë³€ë™ì„± ëŒíŒŒ ì „ëµ</li>
                                    <li>ğŸŒ™ <strong>ì•¼ê°„ 22-9ì‹œ:</strong> RSI ì „ëµ</li>
                                </ul>
                                <small class="text-muted">* ê³ ë³€ë™ì„± ì‹œì¥ì—ì„œëŠ” ë³¼ë¦°ì € ë°´ë“œ ìš°ì„  ì ìš©</small>
                            </div>
                        </div>
                    </div>

                    <!-- ì•™ìƒë¸” ì „ëµ ì„¤ì • -->
                    <div id="ensemble-settings" class="strategy-settings" style="display: none;">
                        <h6 class="mt-4 mb-3">ğŸ”¥ ì•™ìƒë¸” ì „ëµ ì„¤ì •</h6>
                        <div class="alert alert-warning">
                            <small><strong>ì„¤ëª…:</strong> ì—¬ëŸ¬ ì „ëµì˜ ì‹ í˜¸ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ë§¤ë§¤ ê²°ì •. ìµœì†Œ 2ê°œ ì „ëµì´ ê°™ì€ ë°©í–¥ì¼ ë•Œë§Œ ë§¤ë§¤</small>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                {{ form.ensemble_volatility_weight.label(class="form-label") }}
                                {{ form.ensemble_volatility_weight(class="form-control") }}
                                <small class="text-muted">í•©ê³„ 1.0ì´ ë˜ë„ë¡</small>
                            </div>
                            <div class="col-md-4">
                                {{ form.ensemble_bollinger_weight.label(class="form-label") }}
                                {{ form.ensemble_bollinger_weight(class="form-control") }}
                                <small class="text-muted">ì¡°ì •í•´ì£¼ì„¸ìš”</small>
                            </div>
                            <div class="col-md-4">
                                {{ form.ensemble_rsi_weight.label(class="form-label") }}
                                {{ form.ensemble_rsi_weight(class="form-control") }}
                                <small class="text-muted">ê¸°ë³¸ê°’ ì‚¬ìš© ê¶Œì¥</small>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <small><strong>ê¶Œì¥ ê°€ì¤‘ì¹˜:</strong></small>
                            <ul class="list-unstyled mt-2 mb-0">
                                <li>â€¢ ì•ˆì •í˜•: ë³¼ë¦°ì € 0.5, RSI 0.4, ë³€ë™ì„± 0.1</li>
                                <li>â€¢ ê· í˜•í˜•: ë³¼ë¦°ì € 0.4, RSI 0.3, ë³€ë™ì„± 0.3 (ê¸°ë³¸ê°’)</li>
                                <li>â€¢ ê³µê²©í˜•: ë³€ë™ì„± 0.5, ë³¼ë¦°ì € 0.3, RSI 0.2</li>
                            </ul>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        {{ form.submit(class="btn btn-primary btn-lg flex-fill") }}
                        <button type="button" class="btn btn-outline-success btn-lg" data-bs-toggle="modal" data-bs-target="#saveFavoriteModal">
                            <i class="fas fa-bookmark"></i> í˜„ì¬ ì„¤ì • ì €ì¥
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ì¦ê²¨ì°¾ê¸° ì €ì¥ Modal -->
<div class="modal fade" id="saveFavoriteModal" tabindex="-1" aria-labelledby="saveFavoriteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="favoriteForm" method="POST" action="{{ url_for('main.save_favorite') }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveFavoriteModalLabel">ì¦ê²¨ì°¾ê¸°ë¡œ ì €ì¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>í˜„ì¬ í˜ì´ì§€ì˜ ì„¤ì •ì„ ì¦ê²¨ì°¾ê¸°ì— ì €ì¥í•©ë‹ˆë‹¤. ë‚˜ì¤‘ì— ì‰½ê²Œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆë„ë¡ ì´ë¦„ì„ ì§€ì •í•´ì£¼ì„¸ìš”.</p>

                    <!-- ì¦ê²¨ì°¾ê¸° ì´ë¦„ í¼ -->
                    {{ favorite_form.hidden_tag() }}
                    <div class="mb-3">
                        {{ favorite_form.name.label(class="form-label") }}
                        {{ favorite_form.name(class="form-control", id="favorite_name_input") }}
                        {% if favorite_form.name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ favorite_form.name.errors[0] }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- ìë™ ê±°ë˜ ì‹œì‘ ì²´í¬ë°•ìŠ¤ -->
                    <div class="form-check mb-3">
                        {{ favorite_form.start_yn(class="form-check-input", id="start_yn_checkbox") }}
                        {{ favorite_form.start_yn.label(class="form-check-label") }}
                        <small class="form-text text-muted d-block">ì²´í¬í•˜ë©´ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì‹œ ìë™ê±°ë˜ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ì„¤ì • ì €ì¥ í™•ì¸ íŒì—… (ê¸°ì¡´ ì¦ê²¨ì°¾ê¸° íŒì—…ê³¼ëŠ” ë³„ê°œ) -->
<div class="modal fade" id="settingsSaveConfirmModal" tabindex="-1" aria-labelledby="settingsSaveConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="settingsSaveConfirmModalLabel">ì„¤ì • ì €ì¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>ì„¤ì •ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="saveToFavorites">
                    <label class="form-check-label" for="saveToFavorites">
                        <i class="fas fa-bookmark"></i> ì¦ê²¨ì°¾ê¸°ì—ë„ ì €ì¥
                    </label>
                    <small class="form-text text-muted d-block">ì²´í¬í•˜ë©´ í˜„ì¬ ì„¤ì •ì„ ì¦ê²¨ì°¾ê¸°ë¡œë„ ì €ì¥í•©ë‹ˆë‹¤.</small>
                </div>
                <div id="favoriteNameSection" style="display: none;">
                    <div class="mb-3">
                        <label for="quickFavoriteName" class="form-label">ì¦ê²¨ì°¾ê¸° ì´ë¦„</label>
                        <input type="text" class="form-control" id="quickFavoriteName" placeholder="ì˜ˆ: ì˜¤í›„ RSI ì „ëµ">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="quickStartYn">
                        <label class="form-check-label" for="quickStartYn">
                            ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì‹œ ìë™ê±°ë˜ ì‹œì‘
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirmSettingsSave">ì €ì¥</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const strategySelect = document.getElementById('strategy');
    const strategySettings = document.querySelectorAll('.strategy-settings');
    const favoriteForm = document.getElementById('favoriteForm');

    if(favoriteForm) {
        favoriteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const mainForm = document.getElementById('settingsForm');
            const mainFormData = new FormData(mainForm);

            for (let [key, value] of mainFormData.entries()) {
                if (!favoriteForm.querySelector(`[name="${key}"]`)) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = key;
                    hiddenInput.value = value;
                    favoriteForm.appendChild(hiddenInput);
                }
            }
            this.submit();
        });
    }

    // ëª¨ë°”ì¼ ìŠ¬ë¼ì´ë” ê¸°ëŠ¥ (1000ì› ë‹¨ìœ„ë¡œ ìˆ˜ì •)
    function setupMobileSlider(sliderId, inputId, displayId, formatter) {
        const slider = document.getElementById(sliderId);
        const input = document.getElementById(inputId);
        const display = document.getElementById(displayId);

        if (slider && input && display) {
            slider.addEventListener('input', function() {
                let value = parseFloat(this.value);

                // 1000ì› ë‹¨ìœ„ë¡œ ë°˜ì˜¬ë¦¼ (min_cash_sliderì˜ ê²½ìš°)
                if (sliderId === 'min_cash_slider') {
                    value = Math.round(value / 1000) * 1000;
                    this.value = value; // ìŠ¬ë¼ì´ë” ìœ„ì¹˜ë„ ì¡°ì •
                }

                input.value = value;
                display.textContent = formatter(value);
            });

            // ì´ˆê¸°ê°’ ì„¤ì • (1000ì› ë‹¨ìœ„ë¡œ ë°˜ì˜¬ë¦¼)
            let initialValue = parseFloat(input.value || slider.min);
            if (sliderId === 'min_cash_slider') {
                initialValue = Math.round(initialValue / 1000) * 1000;
            }

            slider.value = initialValue;
            input.value = initialValue;
            display.textContent = formatter(initialValue);
        }
    }

    // í¬ë§·í„° í•¨ìˆ˜ë“¤
    function formatCurrency(amount) {
        return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
    }

    function formatSeconds(seconds) {
        if (seconds >= 60) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            if (remainingSeconds === 0) {
                return minutes + 'ë¶„';
            } else {
                return minutes + 'ë¶„ ' + remainingSeconds + 'ì´ˆ';
            }
        }
        return seconds + 'ì´ˆ';
    }

    function formatPercentage(value) {
        return Math.round(value * 100) + '%';
    }

    // ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
    setupMobileSlider('min_cash_slider', 'min_cash_input', 'min_cash_display', formatCurrency);
    setupMobileSlider('sleep_time_slider', 'sleep_time_input', 'sleep_time_display', formatSeconds);
    setupMobileSlider('sell_portion_slider', 'sell_portion_input', 'sell_portion_display', formatPercentage);

    function toggleSettings() {
        strategySettings.forEach(setting => {
            setting.style.display = 'none';
        });

        const selectedStrategy = strategySelect.value;
        const targetSetting = document.getElementById(selectedStrategy + '-settings');

        if (targetSetting) {
            targetSetting.style.display = 'block';
        }
    }

    toggleSettings();
    strategySelect.addEventListener('change', toggleSettings);

    // ì•™ìƒë¸” ê°€ì¤‘ì¹˜ ì‹¤ì‹œê°„ ê²€ì¦
    const weightInputs = [
        document.getElementById('ensemble_volatility_weight'),
        document.getElementById('ensemble_bollinger_weight'),
        document.getElementById('ensemble_rsi_weight')
    ];

    function validateWeights() {
        if (!weightInputs.every(input => input)) return;

        const total = weightInputs.reduce((sum, input) => sum + parseFloat(input.value || 0), 0);
        const isValid = Math.abs(total - 1.0) < 0.01;

        weightInputs.forEach(input => {
            input.classList.toggle('is-invalid', !isValid);
            input.classList.toggle('is-valid', isValid);
        });

        let warningDiv = document.getElementById('weight-warning');
        if (!isValid && !warningDiv) {
            warningDiv = document.createElement('div');
            warningDiv.id = 'weight-warning';
            warningDiv.className = 'alert alert-danger mt-2';
            warningDiv.innerHTML = `<small>ê°€ì¤‘ì¹˜ í•©ê³„ê°€ 1.0ì´ ì•„ë‹™ë‹ˆë‹¤. (í˜„ì¬: ${total.toFixed(2)})</small>`;
            weightInputs[0].parentNode.parentNode.appendChild(warningDiv);
        } else if (isValid && warningDiv) {
            warningDiv.remove();
        }
    }

    weightInputs.forEach(input => {
        if (input) {
            input.addEventListener('input', validateWeights);
        }
    });

    // ì¦ê²¨ì°¾ê¸° ê´€ë ¨ ë¡œì§
    const settingsForm = document.getElementById('settingsForm');
    const saveToFavoritesCheckbox = document.getElementById('saveToFavorites');
    const favoriteNameSection = document.getElementById('favoriteNameSection');
    const confirmModal = new bootstrap.Modal(document.getElementById('settingsSaveConfirmModal'));
    const dateString = new Date().toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).replace(/\D/g, '');

    saveToFavoritesCheckbox.addEventListener('change', function() {
        if (this.checked) {
            favoriteNameSection.style.display = 'block';
            const ticker = document.querySelector('select[name="ticker"]').value;
            const strategy = document.querySelector('select[name="strategy"]').value;
            const defaultName = `${ticker}_${strategy}_${dateString}`;
            document.getElementById('quickFavoriteName').value = defaultName;
        } else {
            favoriteNameSection.style.display = 'none';
        }
    });

    settingsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        confirmModal.show();
    });

    document.getElementById('confirmSettingsSave').addEventListener('click', function() {
        const shouldSaveToFavorites = saveToFavoritesCheckbox.checked;

        if (shouldSaveToFavorites) {
            const favoriteName = document.getElementById('quickFavoriteName').value.trim();
            const startYn = document.getElementById('quickStartYn').checked;

            if (!favoriteName) {
                alert('ì¦ê²¨ì°¾ê¸° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const favoriteNameField = document.createElement('input');
            favoriteNameField.type = 'hidden';
            favoriteNameField.name = 'save_to_favorites';
            favoriteNameField.value = 'true';
            settingsForm.appendChild(favoriteNameField);

            const favoriteNameValueField = document.createElement('input');
            favoriteNameValueField.type = 'hidden';
            favoriteNameValueField.name = 'favorite_name';
            favoriteNameValueField.value = favoriteName;
            settingsForm.appendChild(favoriteNameValueField);

            const favoriteStartYnField = document.createElement('input');
            favoriteStartYnField.type = 'hidden';
            favoriteStartYnField.name = 'favorite_start_yn';
            favoriteStartYnField.value = startYn ? 'true' : 'false';
            settingsForm.appendChild(favoriteStartYnField);
        }

        confirmModal.hide();
        HTMLFormElement.prototype.submit.call(settingsForm);
    });

    document.getElementById('settingsSaveConfirmModal').addEventListener('hidden.bs.modal', function() {
        saveToFavoritesCheckbox.checked = false;
        favoriteNameSection.style.display = 'none';
        document.getElementById('quickFavoriteName').value = '';
        document.getElementById('quickStartYn').checked = false;
    });

    // ===== í”„ë¦¬ì…‹ ë²„íŠ¼ê³¼ í†µí™” ì…ë ¥ í•„ë“œ ë¡œì§ =====

    // í”„ë¦¬ì…‹ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    document.querySelectorAll('.preset-btn').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const value = this.getAttribute('data-value');
            const targetInput = document.getElementById(targetId);

            if (targetInput) {
                // ìˆ«ì ê°’ìœ¼ë¡œ ì„¤ì • (ì½¤ë§ˆ ì—†ì´)
                targetInput.value = value;

                // ì„ íƒëœ ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸
                const parentGroup = this.parentElement;
                parentGroup.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');

                // í¬ë§·íŒ…ëœ í‘œì‹œ ì—…ë°ì´íŠ¸
                formatInputDisplay(targetInput);
            }
        });
    });

    // í†µí™” ì…ë ¥ í•„ë“œ í¬ë§·íŒ… í•¨ìˆ˜ (1000ì› ë‹¨ìœ„ ì²˜ë¦¬)
    function formatInputDisplay(input) {
        const rawValue = input.value.replace(/[^\d]/g, '');
        if (rawValue) {
            let numValue = parseInt(rawValue);

            // 1000ì› ë‹¨ìœ„ë¡œ ë°˜ì˜¬ë¦¼
            numValue = Math.round(numValue / 1000) * 1000;

            // í™”ë©´ í‘œì‹œìš© (ì½ê¸° ì „ìš©)
            input.setAttribute('data-formatted', numValue.toLocaleString('ko-KR'));
            // ì‹¤ì œ í¼ ì „ì†¡ê°’ì€ ìˆ«ìë§Œ
            input.value = numValue;
        }
    }

    // í†µí™” ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸
    document.querySelectorAll('.currency-input').forEach(input => {
        // ì´ˆê¸° í¬ë§·íŒ…
        formatInputDisplay(input);

        input.addEventListener('input', function() {
            // ì…ë ¥ ì¤‘ì—ëŠ” ìˆ«ìë§Œ í—ˆìš©
            let value = this.value.replace(/[^\d]/g, '');
            this.value = value;
        });

        // í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ í¬ë§· ì ìš© (1000ì› ë‹¨ìœ„ë¡œ ë°˜ì˜¬ë¦¼)
        input.addEventListener('blur', function() {
            let rawValue = this.value.replace(/[^\d]/g, '');
            if (rawValue) {
                let numValue = parseInt(rawValue);
                // 1000ì› ë‹¨ìœ„ë¡œ ë°˜ì˜¬ë¦¼
                numValue = Math.round(numValue / 1000) * 1000;
                this.value = numValue;

                formatInputDisplay(this);
                // í™”ë©´ì— ì½¤ë§ˆ í¬í•¨ëœ ê°’ í‘œì‹œ
                if (this.getAttribute('data-formatted')) {
                    this.style.textAlign = 'right';
                    this.setAttribute('placeholder', this.getAttribute('data-formatted') + 'ì›');
                }
            }
        });

        // í¬ì»¤ìŠ¤ ì‹œ ìˆ«ìë§Œ í‘œì‹œ
        input.addEventListener('focus', function() {
            this.style.textAlign = 'left';
            this.setAttribute('placeholder', 'ì§ì ‘ ì…ë ¥');
        });
    });

    // í¼ ì „ì†¡ ì „ ë°ì´í„° ì •ë¦¬
    settingsForm.addEventListener('submit', function() {
        document.querySelectorAll('.currency-input').forEach(input => {
            // ì½¤ë§ˆ ì œê±°í•˜ê³  ìˆœìˆ˜ ìˆ«ìë§Œ ì „ì†¡
            const cleanValue = input.value.replace(/[^\d]/g, '');
            if (cleanValue) {
                let numValue = parseInt(cleanValue);
                // 1000ì› ë‹¨ìœ„ë¡œ ë°˜ì˜¬ë¦¼
                numValue = Math.round(numValue / 1000) * 1000;
                input.value = numValue;
            }
        });
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ê°’ë“¤ì— ëŒ€í•œ í”„ë¦¬ì…‹ ë²„íŠ¼ í™œì„±í™”
    function activateMatchingPresets() {
        document.querySelectorAll('.currency-input').forEach(input => {
            const currentValue = input.value;
            const targetId = input.id;

            // í•´ë‹¹ ì…ë ¥ í•„ë“œì˜ í”„ë¦¬ì…‹ ë²„íŠ¼ë“¤ í™•ì¸
            const presetButtons = document.querySelectorAll(`[data-target="${targetId}"]`);
            presetButtons.forEach(btn => {
                if (btn.getAttribute('data-value') === currentValue) {
                    btn.classList.add('active');
                }
            });
        });
    }

    // ì´ˆê¸° í™œì„±í™”
    activateMatchingPresets();
});
</script>

<style>
    @media (max-width: 768px) {
        .mobile-slider-container {
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            margin: 8px 0;
            border: 1px solid #dee2e6;
        }

        .mobile-slider {
            width: 100%;
            margin: 10px 0;
            height: 8px;
            background: linear-gradient(to right, #e9ecef 0%, #0d6efd 100%);
            border-radius: 5px;
            outline: none;
            transition: all 0.2s;
        }

        .mobile-slider::-webkit-slider-thumb {
            width: 24px;
            height: 24px;
            background: #0d6efd;
            border: 3px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        .mobile-slider::-webkit-slider-thumb:hover {
            background: #0b5ed7;
            transform: scale(1.1);
        }

        .mobile-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #0d6efd;
            border: 3px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .slider-value-display {
            text-align: center;
            font-weight: bold;
            color: #0d6efd;
            font-size: 1.2em;
            margin-top: 5px;
            padding: 5px;
            background: rgba(13, 110, 253, 0.1);
            border-radius: 6px;
        }

        .form-range {
            height: 8px;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        .mobile-slider-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* ë°ìŠ¤í¬í†±ì—ì„œëŠ” ê¸°ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        @media (min-width: 769px) {
            .mobile-slider-container {
                background: transparent;
                border: none;
                padding: 0;
            }

            .mobile-slider-container:hover {
                transform: none;
                box-shadow: none;
            }
        }
    }

    /* ì¦ê²¨ì°¾ê¸° ì—¬ë¶€ íŒì—… */
    #favoriteNameSection {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #007bff;
    }

    .form-check-label i {
        color: #007bff;
    }

    #settingsSaveConfirmModal .modal-body {
        font-size: 16px;
    }

    #favoriteNameSection .form-text {
        margin-top: 5px;
    }

    /* í”„ë¦¬ì…‹ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .preset-buttons {
        margin-bottom: 8px;
    }

    .preset-btn {
        font-size: 0.8rem;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .preset-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .preset-btn.active {
        background-color: var(--bs-primary);
        color: white;
        border-color: var(--bs-primary);
    }

    /* í†µí™” ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
    .currency-input {
        text-align: right;
        font-weight: 500;
    }

    .currency-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    /* ì…ë ¥ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
    .input-group-text {
        background-color: #f8f9fa;
        border-left: none;
        font-weight: 500;
    }

    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
    @media (max-width: 768px) {
        .preset-buttons .btn-group-sm {
            justify-content: center;
        }

        .preset-btn {
            flex: 1;
            min-width: 60px;
        }
    }
</style>
{% endblock %}