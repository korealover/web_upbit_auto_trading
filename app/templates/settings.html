{% extends "base.html" %}

{% block content %}
<h2>ê±°ë˜ ë´‡ ì„¤ì •</h2>

<div class="row mt-4">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ê±°ë˜ ì„¤ì •</h5>
                <small class="text-muted">ì „ëµë³„ ìƒì„¸ ì„¤ì •ì€ ì•„ë˜ì—ì„œ í™•ì¸í•˜ì„¸ìš”</small>
            </div>
            <div class="card-body">
                <form method="POST" action="/settings">
                    {{ form.hidden_tag() }}

                    <!-- ê¸°ë³¸ ì„¤ì • -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            {{ form.ticker.label(class="form-label") }}
                            {{ form.ticker(class="form-select") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.strategy.label(class="form-label") }}
                            {{ form.strategy(class="form-select") }}
                        </div>
                        <div class="col-md-4">
                            {{ form.interval.label(class="form-label") }}
                            {{ form.interval(class="form-select") }}
                        </div>
                    </div>

                    <!-- ê³µí†µ ì„¤ì • -->
                    <h6 class="mt-4 mb-3">ê³µí†µ ì„¤ì •</h6>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            {{ form.buy_amount.label(class="form-label") }}
                            {{ form.buy_amount(class="form-control") }}
                            <small class="text-muted">ìµœì†Œ 5,000ì› ì´ìƒ</small>
                        </div>
                        <div class="col-md-3">
                            {{ form.min_cash.label(class="form-label") }}
                            {{ form.min_cash(class="form-control") }}
                            <small class="text-muted">ì•ˆì „ ìê¸ˆ</small>
                        </div>
                        <div class="col-md-3">
                            {{ form.sleep_time.label(class="form-label") }}
                            {{ form.sleep_time(class="form-control") }}
                            <small class="text-muted">ì‹ í˜¸ í™•ì¸ ê°„ê²©</small>
                        </div>
                        <div class="col-md-3">
                            {{ form.sell_portion.label(class="form-label") }}
                            {{ form.sell_portion(class="form-control") }}
                            <small class="text-muted">ë§¤ë„ ë¹„ìœ¨</small>
                        </div>
                    </div>

                    <!-- ë³¼ë¦°ì € ë°´ë“œ ì „ëµ ì„¤ì • -->
                    <div id="bollinger-settings" class="strategy-settings">
                        <h6 class="mt-4 mb-3">ğŸ“Š ë³¼ë¦°ì € ë°´ë“œ ì „ëµ ì„¤ì •</h6>
                        <div class="alert alert-info">
                            <small><strong>ì„¤ëª…:</strong> ê°€ê²©ì´ ë³¼ë¦°ì € ë°´ë“œ ìƒë‹¨ì„ ëŒíŒŒí•˜ë©´ ë§¤ë„, í•˜ë‹¨ì„ ëŒíŒŒí•˜ë©´ ë§¤ìˆ˜í•˜ëŠ” ì „ëµ</small>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.window.label(class="form-label") }}
                                {{ form.window(class="form-control") }}
                                <small class="text-muted">ì´ë™í‰ê·  ê³„ì‚° ê¸°ê°„</small>
                            </div>
                            <div class="col-md-6">
                                {{ form.multiplier.label(class="form-label") }}
                                {{ form.multiplier(class="form-control") }}
                                <small class="text-muted">ë°´ë“œ í­ ì¡°ì ˆ</small>
                            </div>
                        </div>
                    </div>

                    <!-- ë³€ë™ì„± ëŒíŒŒ ì „ëµ ì„¤ì • -->
                    <div id="volatility-settings" class="strategy-settings" style="display: none;">
                        <h6 class="mt-4 mb-3">ğŸš€ ë³€ë™ì„± ëŒíŒŒ ì „ëµ ì„¤ì •</h6>
                        <div class="alert alert-info">
                            <small><strong>ì„¤ëª…:</strong> ë‹¹ì¼ ì‹œê°€ + (ì „ì¼ ë³€ë™í­ Ã— k) ë¥¼ ëŒíŒŒí•˜ë©´ ë§¤ìˆ˜í•˜ëŠ” ì „ëµ</small>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                {{ form.k.label(class="form-label") }}
                                {{ form.k(class="form-control") }}
                                <small class="text-muted">0.3~0.7 ê¶Œì¥</small>
                            </div>
                            <div class="col-md-4">
                                {{ form.target_profit.label(class="form-label") }}
                                {{ form.target_profit(class="form-control") }}
                                <small class="text-muted">ìµì ˆ ê¸°ì¤€</small>
                            </div>
                            <div class="col-md-4">
                                {{ form.stop_loss.label(class="form-label") }}
                                {{ form.stop_loss(class="form-control") }}
                                <small class="text-muted">ì†ì ˆ ê¸°ì¤€</small>
                            </div>
                        </div>
                    </div>

                    <!-- RSI ì „ëµ ì„¤ì • -->
                    <div id="rsi-settings" class="strategy-settings" style="display: none;">
                        <h6 class="mt-4 mb-3">ğŸ“ˆ RSI ì „ëµ ì„¤ì •</h6>
                        <div class="alert alert-info">
                            <small><strong>ì„¤ëª…:</strong> RSI ì§€í‘œë¥¼ ì´ìš©í•˜ì—¬ ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„ êµ¬ê°„ì—ì„œ ë§¤ë§¤í•˜ëŠ” ì „ëµ</small>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-3">
                                {{ form.rsi_period.label(class="form-label") }}
                                {{ form.rsi_period(class="form-control") }}
                                <small class="text-muted">RSI ê³„ì‚° ê¸°ê°„</small>
                            </div>
                            <div class="col-md-3">
                                {{ form.rsi_oversold.label(class="form-label") }}
                                {{ form.rsi_oversold(class="form-control") }}
                                <small class="text-muted">ê³¼ë§¤ë„ ê¸°ì¤€</small>
                            </div>
                            <div class="col-md-3">
                                {{ form.rsi_overbought.label(class="form-label") }}
                                {{ form.rsi_overbought(class="form-control") }}
                                <small class="text-muted">ê³¼ë§¤ìˆ˜ ê¸°ì¤€</small>
                            </div>
                            <div class="col-md-3">
                                {{ form.rsi_timeframe.label(class="form-label") }}
                                {{ form.rsi_timeframe(class="form-select") }}
                                <small class="text-muted">ë¶„ì„ ì‹œê°„ëŒ€</small>
                            </div>
                        </div>
                    </div>

                    <!-- ì–´ëŒ‘í‹°ë¸Œ ì „ëµ ì„¤ì • -->
                    <div id="adaptive-settings" class="strategy-settings" style="display: none;">
                        <h6 class="mt-4 mb-3">ğŸ¯ ì–´ëŒ‘í‹°ë¸Œ ì „ëµ ì„¤ì •</h6>
                        <div class="alert alert-success">
                            <small><strong>ì„¤ëª…:</strong> ì‹œì¥ ìƒí™©(ì¶”ì„¸/íš¡ë³´/ê³ ë³€ë™ì„±)ê³¼ ì‹œê°„ëŒ€ë¥¼ ìë™ ê°ì§€í•˜ì—¬ ìµœì ì˜ ì „ëµì„ ì„ íƒ</small>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <h6>ìë™ ì ìš© ì „ëµ:</h6>
                                <ul class="list-unstyled">
                                    <li>ğŸŒ… <strong>ì˜¤ì „ 9-12ì‹œ:</strong> ë³€ë™ì„± ëŒíŒŒ ì „ëµ</li>
                                    <li>ğŸ½ï¸ <strong>ì ì‹¬ 12-14ì‹œ:</strong> RSI ì „ëµ (ë³´ìˆ˜ì )</li>
                                    <li>ğŸŒ‡ <strong>ì˜¤í›„ 14-18ì‹œ:</strong> ë³¼ë¦°ì € ë°´ë“œ ì „ëµ</li>
                                    <li>ğŸŒƒ <strong>ì €ë… 18-22ì‹œ:</strong> ë³€ë™ì„± ëŒíŒŒ ì „ëµ</li>
                                    <li>ğŸŒ™ <strong>ì•¼ê°„ 22-9ì‹œ:</strong> RSI ì „ëµ</li>
                                </ul>
                                <small class="text-muted">* ê³ ë³€ë™ì„± ì‹œì¥ì—ì„œëŠ” ë³¼ë¦°ì € ë°´ë“œ ìš°ì„  ì ìš©</small>
                            </div>
                        </div>
                    </div>

                    <!-- ì•™ìƒë¸” ì „ëµ ì„¤ì • -->
                    <div id="ensemble-settings" class="strategy-settings" style="display: none;">
                        <h6 class="mt-4 mb-3">ğŸ”¥ ì•™ìƒë¸” ì „ëµ ì„¤ì •</h6>
                        <div class="alert alert-warning">
                            <small><strong>ì„¤ëª…:</strong> ì—¬ëŸ¬ ì „ëµì˜ ì‹ í˜¸ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ë§¤ë§¤ ê²°ì •. ìµœì†Œ 2ê°œ ì „ëµì´ ê°™ì€ ë°©í–¥ì¼ ë•Œë§Œ ë§¤ë§¤</small>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                {{ form.ensemble_volatility_weight.label(class="form-label") }}
                                {{ form.ensemble_volatility_weight(class="form-control") }}
                                <small class="text-muted">í•©ê³„ 1.0ì´ ë˜ë„ë¡</small>
                            </div>
                            <div class="col-md-4">
                                {{ form.ensemble_bollinger_weight.label(class="form-label") }}
                                {{ form.ensemble_bollinger_weight(class="form-control") }}
                                <small class="text-muted">ì¡°ì •í•´ì£¼ì„¸ìš”</small>
                            </div>
                            <div class="col-md-4">
                                {{ form.ensemble_rsi_weight.label(class="form-label") }}
                                {{ form.ensemble_rsi_weight(class="form-control") }}
                                <small class="text-muted">ê¸°ë³¸ê°’ ì‚¬ìš© ê¶Œì¥</small>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <small><strong>ê¶Œì¥ ê°€ì¤‘ì¹˜:</strong></small>
                            <ul class="list-unstyled mt-2 mb-0">
                                <li>â€¢ ì•ˆì •í˜•: ë³¼ë¦°ì € 0.5, RSI 0.4, ë³€ë™ì„± 0.1</li>
                                <li>â€¢ ê· í˜•í˜•: ë³¼ë¦°ì € 0.4, RSI 0.3, ë³€ë™ì„± 0.3 (ê¸°ë³¸ê°’)</li>
                                <li>â€¢ ê³µê²©í˜•: ë³€ë™ì„± 0.5, ë³¼ë¦°ì € 0.3, RSI 0.2</li>
                            </ul>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        {{ form.submit(class="btn btn-primary btn-lg") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const strategySelect = document.getElementById('strategy');
        const strategySettings = document.querySelectorAll('.strategy-settings');

        function toggleSettings() {
            // ëª¨ë“  ì„¤ì • ìˆ¨ê¸°ê¸°
            strategySettings.forEach(setting => {
                setting.style.display = 'none';
            });

            // ì„ íƒëœ ì „ëµ ì„¤ì • ë³´ì´ê¸°
            const selectedStrategy = strategySelect.value;
            const targetSetting = document.getElementById(selectedStrategy + '-settings');

            if (targetSetting) {
                targetSetting.style.display = 'block';
            }
        }

        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        toggleSettings();

        // ì „ëµ ë³€ê²½ ì‹œ ì„¤ì • í† ê¸€
        strategySelect.addEventListener('change', toggleSettings);

        // ì•™ìƒë¸” ê°€ì¤‘ì¹˜ ì‹¤ì‹œê°„ ê²€ì¦
        const weightInputs = [
            document.getElementById('ensemble_volatility_weight'),
            document.getElementById('ensemble_bollinger_weight'),
            document.getElementById('ensemble_rsi_weight')
        ];

        function validateWeights() {
            if (!weightInputs.every(input => input)) return;

            const total = weightInputs.reduce((sum, input) => sum + parseFloat(input.value || 0), 0);
            const isValid = Math.abs(total - 1.0) < 0.01;

            weightInputs.forEach(input => {
                input.classList.toggle('is-invalid', !isValid);
                input.classList.toggle('is-valid', isValid);
            });

            // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ/ìˆ¨ê¸°ê¸°
            let warningDiv = document.getElementById('weight-warning');
            if (!isValid && !warningDiv) {
                warningDiv = document.createElement('div');
                warningDiv.id = 'weight-warning';
                warningDiv.className = 'alert alert-danger mt-2';
                warningDiv.innerHTML = `<small>ê°€ì¤‘ì¹˜ í•©ê³„ê°€ 1.0ì´ ì•„ë‹™ë‹ˆë‹¤. (í˜„ì¬: ${total.toFixed(2)})</small>`;
                weightInputs[0].parentNode.parentNode.appendChild(warningDiv);
            } else if (isValid && warningDiv) {
                warningDiv.remove();
            }
        }

        weightInputs.forEach(input => {
            if (input) {
                input.addEventListener('input', validateWeights);
            }
        });
    });
</script>
{% endblock %}