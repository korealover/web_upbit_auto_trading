{% extends "base.html" %}

{% block content %}
<h2>거래 대시보드</h2>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                잔고 정보
            </div>
            <div class="card-body">
                <p><strong>보유 현금:</strong> {{ "₩{:,.0f}".format(balance_info.cash|default(0)) }}</p>
                <!-- 다른 잔고 정보 -->
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                실행 중인 봇
            </div>
            <div class="card-body">
                {% if trading_bots %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>티커</th>
                                <th>전략</th>
                                <th>상태</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticker, bot_info in trading_bots.items() %}
                            <tr>
                                <td>{{ ticker }}</td>
                                <td>{{ bot_info.strategy }}</td>
                                <td>
                                    {% if bot_info.running %}
                                    <span class="badge bg-success">실행 중</span>
                                    {% else %}
                                    <span class="badge bg-danger">중지됨</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-danger stop-bot" data-ticker="{{ ticker }}">
                                        중지
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p>실행 중인 봇이 없습니다. <a href="/settings">설정</a>에서 봇을 시작하세요.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                실시간 로그
                <div class="float-end">
                    <select id="ticker-selector" class="form-select form-select-sm">
                        <option value="">모든 티커</option>
                        <!-- 활성 티커가 여기에 추가됩니다 -->
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div id="log-container" style="height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; font-family: monospace;">
                    <!-- 로그 메시지가 여기에 추가됩니다 -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                거래 기록
            </div>
            <div class="card-body">
                {% if trade_records %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>날짜/시간</th>
                                <th>티커</th>
                                <th>유형</th>
                                <th>가격</th>
                                <th>수량</th>
                                <th>금액</th>
                                <th>수익률</th>
                                <th>전략</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in trade_records %}
                            <tr>
                                <td>{{ record.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>{{ record.ticker }}</td>
                                <td>
                                    {% if record.trade_type == 'BUY' %}
                                    <span class="badge bg-primary">매수</span>
                                    {% else %}
                                    <span class="badge bg-danger">매도</span>
                                    {% endif %}
                                </td>
                                <td>{{ "₩{:,.0f}".format(record.price) }}</td>
                                <td>{{ "{:.4f}".format(record.volume) }}</td>
                                <td>{{ "₩{:,.0f}".format(record.amount) }}</td>
                                <td>
                                    {% if record.profit_loss %}
                                    <span class="{{ 'text-success' if record.profit_loss > 0 else 'text-danger' }}">
                                        {{ "{:+.2f}%".format(record.profit_loss) }}
                                    </span>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>{{ record.strategy }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p>아직 거래 기록이 없습니다.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const logContainer = document.getElementById('log-container');
        const tickerSelector = document.getElementById('ticker-selector');
        let selectedTicker = '';

        // 활성 티커 로드
        function loadActiveTickers() {
            fetch('/api/active_tickers')
                .then(response => response.json())
                .then(tickers => {
                    // 현재 선택된 티커 저장
                    const currentSelectedTicker = tickerSelector.value;

                    // 기존 옵션 제거 (첫 번째 '모든 티커' 옵션 제외)
                    while (tickerSelector.options.length > 1) {
                        tickerSelector.remove(1);
                    }

                    // 새 티커 옵션 추가
                    tickers.forEach(ticker => {
                        const option = document.createElement('option');
                        option.value = ticker;
                        option.textContent = ticker;
                        tickerSelector.appendChild(option);
                    });

                    // 이전에 선택된 티커가 목록에 있으면 다시 선택
                    if (currentSelectedTicker && tickers.includes(currentSelectedTicker)) {
                        tickerSelector.value = currentSelectedTicker;
                        selectedTicker = currentSelectedTicker;
                    }


                    // 티커가 없으면 메시지 표시
                    if (tickers.length === 0) {
                        logContainer.innerHTML = '<div class="text-muted">실행 중인 봇이 없습니다.</div>';
                    }
                })
                .catch(error => console.error('티커 로드 오류:', error));
        }

        // 티커 변경 이벤트
        tickerSelector.addEventListener('change', function() {
            selectedTicker = this.value;
            logContainer.innerHTML = ''; // 로그 컨테이너 초기화
            fetchLogs(); // 새 티커의 로그 로드
        });

        // 로그 폴링 함수
        function fetchLogs() {
            // 선택된 티커가 없으면 전체 로그 가져오기
            const url = selectedTicker ? `/api/logs/${selectedTicker}` : '/api/logs';

            fetch(url)
                .then(response => response.json())
                .then(logs => {
                    // 로그 컨테이너 업데이트
                    logContainer.innerHTML = '';

                    if (logs.length === 0) {
                        logContainer.innerHTML = '<div class="text-muted">로그가 없습니다.</div>';
                        return;
                    }

                    logs.forEach(log => {
                        const logEntry = document.createElement('div');

                        // 로그 레벨에 따른 스타일 적용
                        let logClass = '';
                        switch(log.level) {
                            case 'ERROR':
                                logClass = 'text-danger';
                                break;
                            case 'WARNING':
                                logClass = 'text-warning';
                                break;
                            case 'INFO':
                                logClass = 'text-info';
                                break;
                            default:
                                logClass = 'text-secondary';
                        }

                        logEntry.className = logClass;
                        logEntry.textContent = `${log.timestamp} - ${log.message}`;

                        // 로그 추가
                        logContainer.appendChild(logEntry);
                    });

                    // 자동 스크롤 다운
                    logContainer.scrollTop = logContainer.scrollHeight;
                })
                .catch(error => console.error('로그 가져오기 오류:', error));
        }

        // 초기 티커 및 로그 로드
        loadActiveTickers();
        fetchLogs();

        // 2초마다 로그 업데이트
        setInterval(fetchLogs, 10000);
        // 30초마다 활성 티커 업데이트
        setInterval(loadActiveTickers, 30000);

        // 봇 중지 버튼 이벤트
        document.querySelectorAll('.stop-bot').forEach(button => {
            button.addEventListener('click', function() {
                const ticker = this.getAttribute('data-ticker');
                if (confirm(`${ticker} 봇을 중지하시겠습니까?`)) {
                    fetch(`/stop_bot/${ticker}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(data.message);
                            location.reload();
                        } else {
                            alert('오류: ' + data.message);
                        }
                    });
                }
            });
        });
    });
</script>
{% endblock %}