{% extends "base.html" %}

{% block content %}
<!-- 기존 HTML 구조는 그대로 유지 -->
<h2>거래 대시보드</h2>

<!-- 전략별 요약 정보 카드 -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">활성 전략 현황</h5>
            </div>
            <div class="card-body">
                {% if trading_bots %}
                <div class="row">
                    {% for ticker, bot_info in trading_bots.items() %}
                    <div class="col-md-4 mb-3">
                        <div class="card border-{% if bot_info.running %}success{% else %}danger{% endif %}">
                            <div class="card-body">
                                <h6 class="card-title">
                                    {{ ticker }}
                                    {% if bot_info.running %}
                                    <span class="badge bg-success">실행중</span>
                                    {% else %}
                                    <span class="badge bg-danger">중지됨</span>
                                    {% endif %}
                                </h6>
                                <p class="card-text">
                                    <strong>전략:</strong>
                                    {% if bot_info.strategy == 'rsi' %}
                                    📈 RSI 전략
                                    {% elif bot_info.strategy == 'adaptive' %}
                                    🎯 어댑티브 전략
                                    {% elif bot_info.strategy == 'ensemble' %}
                                    🔥 앙상블 전략
                                    {% elif bot_info.strategy == 'volatility' %}
                                    🚀 변동성 돌파
                                    {% else %}
                                    📊 볼린저 밴드
                                    {% endif %}
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        {% if bot_info.last_signal_time %}
                                        최근: {{ bot_info.last_signal_time }}
                                        {% else %}
                                        신호 대기 중
                                        {% endif %}
                                    </small>
                                    {% if bot_info.running %}
                                    <button class="btn btn-sm btn-outline-danger stop-bot" data-ticker="{{ ticker }}">
                                        중지
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center">
                    <p class="mb-3">실행 중인 봇이 없습니다.</p>
                    <a href="{{ url_for('main.settings') }}" class="btn btn-primary">새 봇 시작하기</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 잔고 및 성과 정보 -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                💰 잔고 정보
            </div>
            <div class="card-body">
                <p><strong>보유 현금:</strong> {{ "₩{:,.0f}".format(balance_info.cash|default(0)) }}</p>
                <p><strong>총 자산:</strong> {{ "₩{:,.0f}".format(balance_info.total_balance|default(0)) }}</p>
                {% if balance_info.coins %}
                <hr>
                <h6>보유 코인:</h6>
                {% for coin in balance_info.coins %}
                <small>{{ coin.ticker }}: {{ "{:.4f}".format(coin.balance) }}</small><br>
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                📊 오늘의 성과
            </div>
            <div class="card-body">
                {% if daily_stats %}
                <p><strong>총 거래 횟수:</strong> {{ daily_stats.total_trades|default(0) }}회</p>
                <p><strong>성공 거래:</strong> {{ daily_stats.successful_trades|default(0) }}회</p>
                <p><strong>오늘 수익률:</strong>
                    <span class="{% if daily_stats.daily_return > 0 %}text-success{% elif daily_stats.daily_return < 0 %}text-danger{% endif %}">
                        {{ "{:+.2f}%".format(daily_stats.daily_return|default(0)) }}
                    </span>
                </p>
                <p><strong>승률:</strong> {{ "{:.1f}%".format(daily_stats.win_rate|default(0)) }}</p>
                {% else %}
                <p><strong>총 거래 횟수:</strong> 0회</p>
                <p><strong>성공 거래:</strong> 0회</p>
                <p><strong>오늘 수익률:</strong> <span class="text-muted">0.00%</span></p>
                <p><strong>승률:</strong> 0.0%</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                🎯 전략별 성과
            </div>
            <div class="card-body">
                {% if strategy_performance %}
                {% for strategy, perf in strategy_performance.items() %}
                <div class="mb-2">
                    <small>
                        <strong>
                            {% if strategy == 'rsi' %}📈 RSI
                            {% elif strategy == 'adaptive' %}🎯 어댑티브
                            {% elif strategy == 'ensemble' %}🔥 앙상블
                            {% elif strategy == 'volatility' %}🚀 변동성
                            {% else %}📊 볼린저{% endif %}
                        :</strong>
                        <span class="{% if perf.return > 0 %}text-success{% elif perf.return < 0 %}text-danger{% endif %}">
                            {{ "{:+.2f}%".format(perf.return) }}
                        </span>
                        ({{ perf.trades }}회)
                    </small>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted">아직 거래 데이터가 없습니다.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 실시간 로그 (수정된 부분) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>📝 실시간 로그</span>
                <div class="d-flex gap-2 align-items-center">
                    <!-- 로그 표시/숨김 토글 버튼 추가 -->
                    <button id="toggle-logs-btn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i> 로그 보기
                    </button>
                    <span id="connection-status" class="badge bg-secondary" style="display: none;">
                        <i class="fas fa-circle text-warning"></i> 연결 중...
                    </span>
                    <select id="ticker-selector" class="form-select form-select-sm" style="width: 120px; display: none;">
                        <option value="">모든 티커</option>
                    </select>
                    <button id="refresh-logs-btn" class="btn btn-sm btn-outline-primary" style="display: none;">
                        <i class="fas fa-sync-alt"></i> 새로고침
                    </button>
                    <button id="auto-refresh-toggle" class="btn btn-sm btn-outline-secondary" data-auto="true" style="display: none;">
                        <i class="fas fa-pause"></i> 자동 새로고침
                    </button>
                </div>
            </div>
            <div class="card-body" id="log-card-body" style="display: none;">
                <div id="log-container" style="height: 350px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; font-family: 'Courier New', monospace; font-size: 0.9em; border-radius: 5px;">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>로그를 불러오는 중...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 거래 기록 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>📈 거래 기록 <span id="trade-records-title">(오늘의 모든 거래)</span></span>
                <div class="d-flex gap-2">
                    <select id="ticker-filter" class="form-select form-select-sm" style="width: 120px;">
                        <option value="">모든 티커</option>
                    </select>
                    <select id="strategy-filter" class="form-select form-select-sm" style="width: 120px;">
                        <option value="">모든 전략</option>
                        <option value="rsi">📈 RSI</option>
                        <option value="adaptive">🎯 어댑티브</option>
                        <option value="ensemble">🔥 앙상블</option>
                        <option value="volatility">🚀 변동성</option>
                        <option value="bollinger">📊 볼린저</option>
                    </select>
                    <button id="refresh-trades-btn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt"></i> 새로고침
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="trade-records-container">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>거래 기록을 불러오는 중...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;"></div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== 전역 변수 정리 =====
    let socket = null;
    let isWebSocketEnabled = false;
    let isWebSocketConnected = false;
    let autoRefreshInterval = null;
    let isAutoRefresh = true;
    let logBuffer = [];
    let reconnectAttempts = 0;
    const MAX_LOGS = 50; // 로그 수 제한
    const MAX_RECONNECT_ATTEMPTS = 5; // 재연결 시도 제한

    // 로그 표시 상태 변수 추가
    let isLogsVisible = false;

    // DOM 요소들 (안전하게 가져오기)
    const logContainer = document.getElementById('log-container');
    const logCardBody = document.getElementById('log-card-body');
    const toggleLogsBtn = document.getElementById('toggle-logs-btn');
    const tickerSelector = document.getElementById('ticker-selector');
    const strategyFilter = document.getElementById('strategy-filter');
    const tickerFilter = document.getElementById('ticker-filter');
    const connectionStatus = document.getElementById('connection-status');
    const refreshLogsBtn = document.getElementById('refresh-logs-btn');
    const autoRefreshToggle = document.getElementById('auto-refresh-toggle');

    // 상태 변수들
    let selectedTicker = '';
    let selectedStrategy = '';
    let isInitialized = false;

    // ===== 초기화 (한 번만 실행) =====
    if (!isInitialized) {
        init();
        isInitialized = true;
    }

    function init() {
        try {
            loadActiveTickers();
            loadTradeRecords();
            attachEventListeners();
            console.log('대시보드 초기화 완료 (로그는 숨김 상태)');
        } catch (error) {
            console.error('초기화 오류:', error);
            showNotification('error', '페이지 초기화 중 오류가 발생했습니다.');
        }
    }

    // ===== 로그 토글 기능 =====
    function toggleLogs() {
        isLogsVisible = !isLogsVisible;

        if (isLogsVisible) {
            // 로그 보이기
            logCardBody.style.display = 'block';
            connectionStatus.style.display = 'inline-block';
            tickerSelector.style.display = 'inline-block';
            refreshLogsBtn.style.display = 'inline-block';
            autoRefreshToggle.style.display = 'inline-block';

            toggleLogsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> 로그 숨기기';
            toggleLogsBtn.classList.remove('btn-outline-primary');
            toggleLogsBtn.classList.add('btn-outline-secondary');

            // WebSocket 초기화 및 로그 로드
            if (!isWebSocketEnabled) {
                initWebSocket();
            }
            loadLogs();
            startAutoRefresh();

        } else {
            // 로그 숨기기
            logCardBody.style.display = 'none';
            connectionStatus.style.display = 'none';
            tickerSelector.style.display = 'none';
            refreshLogsBtn.style.display = 'none';
            autoRefreshToggle.style.display = 'none';

            toggleLogsBtn.innerHTML = '<i class="fas fa-eye"></i> 로그 보기';
            toggleLogsBtn.classList.remove('btn-outline-secondary');
            toggleLogsBtn.classList.add('btn-outline-primary');

            // WebSocket 연결 종료 및 자동 새로고침 중지
            if (socket && socket.connected) {
                socket.disconnect();
            }
            stopAutoRefresh();
        }
    }

    // ===== WebSocket 초기화 (재연결 제한) =====
    function initWebSocket() {
        if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
            console.warn('최대 재연결 시도 횟수 초과. WebSocket 비활성화');
            isWebSocketEnabled = false;
            updateConnectionStatus('disabled');
            return;
        }

        try {
            if (typeof io !== 'undefined') {
                // 기존 소켓 정리
                if (socket) {
                    socket.disconnect();
                    socket = null;
                }

                socket = io({
                    timeout: 10000,
                    forceNew: true,
                    reconnection: false // 자동 재연결 비활성화
                });

                setupWebSocketEvents();
                isWebSocketEnabled = true;
                reconnectAttempts++;
                console.log('WebSocket 초기화 완료');
            } else {
                console.warn('Socket.IO 라이브러리를 찾을 수 없음');
                isWebSocketEnabled = false;
                updateConnectionStatus('disabled');
            }
        } catch (error) {
            console.error('WebSocket 초기화 오류:', error);
            isWebSocketEnabled = false;
            updateConnectionStatus('error');
        }
    }

    // ===== WebSocket 이벤트 설정 =====
    function setupWebSocketEvents() {
        if (!socket) return;

        socket.on('connect', function() {
            console.log('WebSocket 연결됨');
            isWebSocketConnected = true;
            reconnectAttempts = 0; // 성공 시 재설정
            updateConnectionStatus('connected');

            // 안전한 데이터 요청
            setTimeout(() => {
                if (socket && socket.connected) {
                    socket.emit('request_recent_logs', {
                        ticker: selectedTicker,
                        limit: MAX_LOGS
                    });
                    subscribeToLogs(selectedTicker);
                }
            }, 100);
        });

        socket.on('disconnect', function() {
            console.log('WebSocket 연결 끊김');
            isWebSocketConnected = false;
            updateConnectionStatus('disconnected');
        });

        socket.on('recent_logs', function(data) {
            try {
                if (data && data.logs && Array.isArray(data.logs)) {
                    logBuffer = data.logs.slice(0, MAX_LOGS).reverse();
                    updateLogDisplay();
                }
            } catch (error) {
                console.error('로그 데이터 처리 오류:', error);
            }
        });

        socket.on('new_log', function(logEntry) {
            try {
                if (logEntry && logEntry.message) {
                    addNewLog(logEntry);
                }
            } catch (error) {
                console.error('새 로그 처리 오류:', error);
            }
        });

        socket.on('error', function(data) {
            console.error('WebSocket 오류:', data);
            showNotification('error', data.message || 'WebSocket 오류가 발생했습니다.');
        });

        // 연결 타임아웃 처리
        setTimeout(() => {
            if (!isWebSocketConnected) {
                console.warn('WebSocket 연결 타임아웃');
                updateConnectionStatus('error');
            }
        }, 15000);
    }

    // ===== 메모리 안전한 로그 추가 =====
    function addNewLog(logEntry) {
        try {
            logBuffer.push(logEntry);

            // 메모리 보호: 최대 로그 수 제한
            if (logBuffer.length > MAX_LOGS) {
                logBuffer = logBuffer.slice(-MAX_LOGS);
            }

            updateLogDisplay();
            scrollToBottom();
        } catch (error) {
            console.error('로그 추가 오류:', error);
        }
    }

    // ===== 이벤트 리스너 (중복 방지) =====
    function attachEventListeners() {
        // 로그 토글 버튼 이벤트
        if (toggleLogsBtn) {
            toggleLogsBtn.addEventListener('click', toggleLogs);
        }

        // 기존 이벤트 리스너들은 로그가 보일 때만 작동하도록 조건부 처리
        if (tickerSelector) {
            tickerSelector.addEventListener('change', function() {
                if (isLogsVisible) {
                    selectedTicker = this.value;
                    loadLogs();
                    subscribeToLogs(selectedTicker);
                }
            });
        }

        if (refreshLogsBtn) {
            refreshLogsBtn.addEventListener('click', function() {
                if (isLogsVisible) {
                    loadLogs();
                }
            });
        }

        if (autoRefreshToggle) {
            autoRefreshToggle.addEventListener('click', function() {
                if (isLogsVisible) {
                    toggleAutoRefresh();
                }
            });
        }

        // 거래 기록 관련 이벤트 리스너들 (항상 활성)
        if (tickerFilter) {
            tickerFilter.addEventListener('change', function() {
                selectedTicker = this.value;
                loadTradeRecords();
            });
        }

        if (strategyFilter) {
            strategyFilter.addEventListener('change', function() {
                selectedStrategy = this.value;
                loadTradeRecords();
            });
        }

        const refreshTradesBtn = document.getElementById('refresh-trades-btn');
        if (refreshTradesBtn) {
            refreshTradesBtn.addEventListener('click', loadTradeRecords);
        }

        // 봇 중지 버튼들
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('stop-bot')) {
                const ticker = e.target.getAttribute('data-ticker');
                if (ticker && confirm(`${ticker} 봇을 정말 중지하시겠습니까?`)) {
                    stopBot(ticker);
                }
            }
        });
    }

    // ===== 자동 새로고침 관리 =====
    function startAutoRefresh() {
        if (!isLogsVisible) return;

        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }

        if (isAutoRefresh) {
            autoRefreshInterval = setInterval(() => {
                if (isLogsVisible && !isWebSocketConnected) {
                    loadLogs();
                }
            }, 5000);
        }
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    function toggleAutoRefresh() {
        isAutoRefresh = !isAutoRefresh;
        const btn = autoRefreshToggle;

        if (isAutoRefresh) {
            btn.innerHTML = '<i class="fas fa-pause"></i> 자동 새로고침';
            btn.classList.remove('btn-outline-danger');
            btn.classList.add('btn-outline-secondary');
            startAutoRefresh();
        } else {
            btn.innerHTML = '<i class="fas fa-play"></i> 수동 모드';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-outline-danger');
            stopAutoRefresh();
        }
    }

    // ===== 나머지 기능들은 기존과 동일하게 유지 =====
    function loadLogs() {
        if (!isLogsVisible) return;

        try {
            const url = selectedTicker ? `/logs/${selectedTicker}` : '/logs/all';

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.logs && Array.isArray(data.logs)) {
                        logBuffer = data.logs.slice(0, MAX_LOGS).reverse();
                        updateLogDisplay();
                    } else {
                        throw new Error('잘못된 로그 데이터 형식');
                    }
                })
                .catch(error => {
                    console.error('로그 로딩 오류:', error);
                    if (logContainer) {
                        logContainer.innerHTML = `
                            <div class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                로그를 불러올 수 없습니다: ${error.message}
                            </div>
                        `;
                    }
                });
        } catch (error) {
            console.error('로그 로딩 요청 오류:', error);
        }
    }

    function updateLogDisplay() {
        if (!logContainer || !isLogsVisible) return;

        try {
            if (logBuffer.length === 0) {
                logContainer.innerHTML = '<div class="text-center text-muted">로그가 없습니다.</div>';
                return;
            }

            const logHtml = logBuffer.map(log => {
                const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString('ko-KR') : '';
                const level = log.level || 'INFO';
                const ticker = log.ticker || '';
                const message = log.message || '';

                const levelClass = {
                    'ERROR': 'text-danger',
                    'WARNING': 'text-warning',
                    'INFO': 'text-info',
                    'DEBUG': 'text-secondary'
                }[level] || 'text-dark';

                return `
                    <div class="log-entry mb-1" style="border-left: 3px solid ${level === 'ERROR' ? '#dc3545' : level === 'WARNING' ? '#ffc107' : '#0dcaf0'}; padding-left: 8px;">
                        <small class="text-muted">[${timestamp}]</small>
                        ${ticker ? `<span class="badge bg-secondary me-1">${ticker}</span>` : ''}
                        <span class="badge bg-light text-dark me-1">${level}</span>
                        <span class="${levelClass}">${message}</span>
                    </div>
                `;
            }).join('');

            logContainer.innerHTML = logHtml;
            scrollToBottom();

        } catch (error) {
            console.error('로그 표시 오류:', error);
            logContainer.innerHTML = '<div class="text-center text-danger">로그 표시 중 오류가 발생했습니다.</div>';
        }
    }

    function scrollToBottom() {
        if (logContainer && isLogsVisible) {
            try {
                logContainer.scrollTop = logContainer.scrollHeight;
            } catch (error) {
                console.error('스크롤 오류:', error);
            }
        }
    }

    function subscribeToLogs(ticker) {
        if (!socket || !socket.connected || !isLogsVisible) return;

        try {
            socket.emit('subscribe_logs', { ticker: ticker || '' });
        } catch (error) {
            console.error('로그 구독 오류:', error);
        }
    }

    function updateConnectionStatus(status) {
        if (!connectionStatus) return;

        const statusConfig = {
            'connected': { class: 'bg-success', icon: 'text-white', text: '연결됨' },
            'disconnected': { class: 'bg-danger', icon: 'text-white', text: '연결 끊김' },
            'connecting': { class: 'bg-warning', icon: 'text-dark', text: '연결 중...' },
            'disabled': { class: 'bg-secondary', icon: 'text-white', text: '비활성화' },
            'error': { class: 'bg-danger', icon: 'text-white', text: '오류' }
        };

        const config = statusConfig[status] || statusConfig['error'];

        connectionStatus.className = `badge ${config.class}`;
        connectionStatus.innerHTML = `<i class="fas fa-circle ${config.icon}"></i> ${config.text}`;
    }

    // ===== 기존 함수들 (loadActiveTickers, loadTradeRecords, stopBot, showNotification 등) =====
    function loadActiveTickers() {
        fetch('/api/active-tickers')
            .then(response => response.json())
            .then(data => {
                if (data && data.tickers && Array.isArray(data.tickers)) {
                    updateTickerSelectors(data.tickers);
                }
            })
            .catch(error => {
                console.error('활성 티커 로딩 오류:', error);
            });
    }

    function updateTickerSelectors(tickers) {
        const selectors = [tickerSelector, tickerFilter];

        selectors.forEach(selector => {
            if (selector) {
                const currentValue = selector.value;
                selector.innerHTML = '<option value="">모든 티커</option>';

                tickers.forEach(ticker => {
                    const option = document.createElement('option');
                    option.value = ticker;
                    option.textContent = ticker;
                    selector.appendChild(option);
                });

                if (tickers.includes(currentValue)) {
                    selector.value = currentValue;
                }
            }
        });
    }

    function loadTradeRecords() {
        try {
            let url = '/api/trade-records';
            const params = new URLSearchParams();

            if (selectedTicker) params.append('ticker', selectedTicker);
            if (selectedStrategy) params.append('strategy', selectedStrategy);

            if (params.toString()) {
                url += '?' + params.toString();
            }

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateTradeRecordsDisplay(data);
                })
                .catch(error => {
                    console.error('거래 기록 로딩 오류:', error);
                    const container = document.getElementById('trade-records-container');
                    if (container) {
                        container.innerHTML = `
                            <div class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                거래 기록을 불러올 수 없습니다.
                            </div>
                        `;
                    }
                });
        } catch (error) {
            console.error('거래 기록 요청 오류:', error);
        }
    }

    function updateTradeRecordsDisplay(data) {
        const container = document.getElementById('trade-records-container');
        if (!container) return;

        try {
            if (!data || !data.trades || data.trades.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">거래 기록이 없습니다.</div>';
                return;
            }

            let filterText = '오늘의 모든 거래';
            if (selectedTicker && selectedStrategy) {
                filterText = `${selectedTicker} (${getStrategyName(selectedStrategy)}) 거래`;
            } else if (selectedTicker) {
                filterText = `${selectedTicker} 거래`;
            } else if (selectedStrategy) {
                filterText = `${getStrategyName(selectedStrategy)} 거래`;
            }

            const titleElement = document.getElementById('trade-records-title');
            if (titleElement) {
                titleElement.textContent = `(${filterText})`;
            }

            const tradesHtml = data.trades.map(trade => {
                const profitClass = trade.profit > 0 ? 'text-success' : trade.profit < 0 ? 'text-danger' : 'text-muted';
                const profitIcon = trade.profit > 0 ? '📈' : trade.profit < 0 ? '📉' : '➖';

                return `
                    <div class="row border-bottom py-2 align-items-center">
                        <div class="col-md-2">
                            <strong>${trade.ticker}</strong>
                            <br><small class="text-muted">${trade.timestamp}</small>
                        </div>
                        <div class="col-md-2">
                            <span class="badge ${trade.action === 'BUY' ? 'bg-success' : 'bg-danger'}">
                                ${trade.action === 'BUY' ? '매수' : '매도'}
                            </span>
                            <br><small class="text-muted">${getStrategyName(trade.strategy)}</small>
                        </div>
                        <div class="col-md-2">
                            <strong>₩${trade.price.toLocaleString()}</strong>
                            <br><small class="text-muted">${trade.quantity} 개</small>
                        </div>
                        <div class="col-md-2">
                            <strong>₩${trade.amount.toLocaleString()}</strong>
                        </div>
                        <div class="col-md-2">
                            <span class="${profitClass}">
                                ${profitIcon} ${trade.profit > 0 ? '+' : ''}${trade.profit.toFixed(2)}%
                            </span>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">${trade.reason}</small>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="row border-bottom bg-light py-2 fw-bold">
                    <div class="col-md-2">코인/시간</div>
                    <div class="col-md-2">거래/전략</div>
                    <div class="col-md-2">가격/수량</div>
                    <div class="col-md-2">거래금액</div>
                    <div class="col-md-2">수익률</div>
                    <div class="col-md-2">사유</div>
                </div>
                ${tradesHtml}
            `;

        } catch (error) {
            console.error('거래 기록 표시 오류:', error);
            container.innerHTML = '<div class="text-center text-danger">거래 기록 표시 중 오류가 발생했습니다.</div>';
        }
    }

    function getStrategyName(strategy) {
        const names = {
            'rsi': '📈 RSI',
            'adaptive': '🎯 어댑티브',
            'ensemble': '🔥 앙상블',
            'volatility': '🚀 변동성',
            'bollinger': '📊 볼린저'
        };
        return names[strategy] || strategy;
    }

    function stopBot(ticker) {
        fetch('/stop-bot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ticker: ticker })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('success', `${ticker} 봇이 성공적으로 중지되었습니다.`);
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification('error', data.error || '봇 중지에 실패했습니다.');
            }
        })
        .catch(error => {
            console.error('봇 중지 오류:', error);
            showNotification('error', '봇 중지 중 오류가 발생했습니다.');
        });
    }

    function showNotification(type, message) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;

        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
        const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle';

        const toastHtml = `
            <div id="${toastId}" class="toast ${bgClass} text-white" role="alert">
                <div class="d-flex align-items-center p-3">
                    <i class="fas fa-${icon} me-2"></i>
                    <div class="toast-body flex-grow-1">${message}</div>
                    <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);

        const toastElement = document.getElementById(toastId);
        if (toastElement) {
            const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
            toast.show();

            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
    }

    // ===== 페이지 언로드 시 정리 =====
    window.addEventListener('beforeunload', function() {
        try {
            if (socket && socket.connected) {
                socket.disconnect();
            }
            stopAutoRefresh();
        } catch (error) {
            console.error('정리 중 오류:', error);
        }
    });
});
</script>
{% endblock %}