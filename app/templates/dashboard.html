{% extends "base.html" %}

{% block content %}
<!-- ê¸°ì¡´ HTML êµ¬ì¡°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ -->
<h2>ê±°ë˜ ëŒ€ì‹œë³´ë“œ</h2>

<!-- ì „ëµë³„ ìš”ì•½ ì •ë³´ ì¹´ë“œ -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">í™œì„± ì „ëµ í˜„í™©</h5>
            </div>
            <div class="card-body">
                {% if trading_bots %}
                <div class="row">
                    {% for ticker, bot_info in trading_bots.items() %}
                    <div class="col-md-4 mb-3">
                        <div class="card border-{% if bot_info.running %}success{% else %}danger{% endif %}">
                            <div class="card-body">
                                <h6 class="card-title">
                                    {{ ticker }}
                                    {% if bot_info.running %}
                                    <span class="badge bg-success">ì‹¤í–‰ì¤‘</span>
                                    {% else %}
                                    <span class="badge bg-danger">ì¤‘ì§€ë¨</span>
                                    {% endif %}
                                </h6>
                                <p class="card-text">
                                    <strong>ì „ëµ:</strong>
                                    {% if bot_info.strategy == 'rsi' %}
                                    ğŸ“ˆ RSI ì „ëµ
                                    {% elif bot_info.strategy == 'adaptive' %}
                                    ğŸ¯ ì–´ëŒ‘í‹°ë¸Œ ì „ëµ
                                    {% elif bot_info.strategy == 'ensemble' %}
                                    ğŸ”¥ ì•™ìƒë¸” ì „ëµ
                                    {% elif bot_info.strategy == 'volatility' %}
                                    ğŸš€ ë³€ë™ì„± ëŒíŒŒ
                                    {% else %}
                                    ğŸ“Š ë³¼ë¦°ì € ë°´ë“œ
                                    {% endif %}
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        {% if bot_info.last_signal_time %}
                                        ìµœê·¼: {{ bot_info.last_signal_time }}
                                        {% else %}
                                        ì‹ í˜¸ ëŒ€ê¸° ì¤‘
                                        {% endif %}
                                    </small>
                                    {% if bot_info.running %}
                                    <button class="btn btn-sm btn-outline-danger stop-bot" data-ticker="{{ ticker }}">
                                        ì¤‘ì§€
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center">
                    <p class="mb-3">ì‹¤í–‰ ì¤‘ì¸ ë´‡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    <a href="{{ url_for('main.settings') }}" class="btn btn-primary">ìƒˆ ë´‡ ì‹œì‘í•˜ê¸°</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ì”ê³  ë° ì„±ê³¼ ì •ë³´ -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                ğŸ’° ì”ê³  ì •ë³´
            </div>
            <div class="card-body">
                <p><strong>ë³´ìœ  í˜„ê¸ˆ:</strong> {{ "â‚©{:,.0f}".format(balance_info.cash|default(0)) }}</p>
                <p><strong>ì´ ìì‚°:</strong> {{ "â‚©{:,.0f}".format(balance_info.total_balance|default(0)) }}</p>
                {% if balance_info.coins %}
                <hr>
                <h6>ë³´ìœ  ì½”ì¸:</h6>
                {% for coin in balance_info.coins %}
                <small>{{ coin.ticker }}: {{ "{:.4f}".format(coin.balance) }}</small><br>
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                ğŸ“Š ì˜¤ëŠ˜ì˜ ì„±ê³¼
            </div>
            <div class="card-body">
                {% if daily_stats %}
                <p><strong>ì´ ê±°ë˜ íšŸìˆ˜:</strong> {{ daily_stats.total_trades|default(0) }}íšŒ</p>
                <p><strong>ì„±ê³µ ê±°ë˜:</strong> {{ daily_stats.successful_trades|default(0) }}íšŒ</p>
                <p><strong>ì˜¤ëŠ˜ ìˆ˜ìµë¥ :</strong>
                    <span class="{% if daily_stats.daily_return > 0 %}text-success{% elif daily_stats.daily_return < 0 %}text-danger{% endif %}">
                        {{ "{:+.2f}%".format(daily_stats.daily_return|default(0)) }}
                    </span>
                </p>
                <p><strong>ìŠ¹ë¥ :</strong> {{ "{:.1f}%".format(daily_stats.win_rate|default(0)) }}</p>
                {% else %}
                <p><strong>ì´ ê±°ë˜ íšŸìˆ˜:</strong> 0íšŒ</p>
                <p><strong>ì„±ê³µ ê±°ë˜:</strong> 0íšŒ</p>
                <p><strong>ì˜¤ëŠ˜ ìˆ˜ìµë¥ :</strong> <span class="text-muted">0.00%</span></p>
                <p><strong>ìŠ¹ë¥ :</strong> 0.0%</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                ğŸ¯ ì „ëµë³„ ì„±ê³¼
            </div>
            <div class="card-body">
                {% if strategy_performance %}
                {% for strategy, perf in strategy_performance.items() %}
                <div class="mb-2">
                    <small>
                        <strong>
                            {% if strategy == 'rsi' %}ğŸ“ˆ RSI
                            {% elif strategy == 'adaptive' %}ğŸ¯ ì–´ëŒ‘í‹°ë¸Œ
                            {% elif strategy == 'ensemble' %}ğŸ”¥ ì•™ìƒë¸”
                            {% elif strategy == 'volatility' %}ğŸš€ ë³€ë™ì„±
                            {% else %}ğŸ“Š ë³¼ë¦°ì €{% endif %}
                        :</strong>
                        <span class="{% if perf.return > 0 %}text-success{% elif perf.return < 0 %}text-danger{% endif %}">
                            {{ "{:+.2f}%".format(perf.return) }}
                        </span>
                        ({{ perf.trades }}íšŒ)
                    </small>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted">ì•„ì§ ê±°ë˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ì‹¤ì‹œê°„ ë¡œê·¸ (ìˆ˜ì •ëœ ë¶€ë¶„) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>ğŸ“ ì‹¤ì‹œê°„ ë¡œê·¸</span>
                <div class="d-flex gap-2 align-items-center">
                    <!-- ë¡œê·¸ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€ ë²„íŠ¼ ì¶”ê°€ -->
                    <button id="toggle-logs-btn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i> ë¡œê·¸ ë³´ê¸°
                    </button>
                    <span id="connection-status" class="badge bg-secondary" style="display: none;">
                        <i class="fas fa-circle text-warning"></i> ì—°ê²° ì¤‘...
                    </span>
                    <select id="ticker-selector" class="form-select form-select-sm" style="width: 120px; display: none;">
                        <option value="">ëª¨ë“  í‹°ì»¤</option>
                    </select>
                    <button id="refresh-logs-btn" class="btn btn-sm btn-outline-primary" style="display: none;">
                        <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button id="auto-refresh-toggle" class="btn btn-sm btn-outline-secondary" data-auto="true" style="display: none;">
                        <i class="fas fa-pause"></i> ìë™ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>
            <div class="card-body" id="log-card-body" style="display: none;">
                <div id="log-container" style="height: 350px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; font-family: 'Courier New', monospace; font-size: 0.9em; border-radius: 5px;">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ê±°ë˜ ê¸°ë¡ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>ğŸ“ˆ ê±°ë˜ ê¸°ë¡ <span id="trade-records-title">(ì˜¤ëŠ˜ì˜ ëª¨ë“  ê±°ë˜)</span></span>
                <div class="d-flex gap-2">
                    <select id="ticker-filter" class="form-select form-select-sm" style="width: 120px;">
                        <option value="">ëª¨ë“  í‹°ì»¤</option>
                    </select>
                    <select id="strategy-filter" class="form-select form-select-sm" style="width: 120px;">
                        <option value="">ëª¨ë“  ì „ëµ</option>
                        <option value="rsi">ğŸ“ˆ RSI</option>
                        <option value="adaptive">ğŸ¯ ì–´ëŒ‘í‹°ë¸Œ</option>
                        <option value="ensemble">ğŸ”¥ ì•™ìƒë¸”</option>
                        <option value="volatility">ğŸš€ ë³€ë™ì„±</option>
                        <option value="bollinger">ğŸ“Š ë³¼ë¦°ì €</option>
                    </select>
                    <button id="refresh-trades-btn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="trade-records-container">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>ê±°ë˜ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;"></div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== ì „ì—­ ë³€ìˆ˜ ì •ë¦¬ =====
    let socket = null;
    let isWebSocketEnabled = false;
    let isWebSocketConnected = false;
    let autoRefreshInterval = null;
    let isAutoRefresh = true;
    let logBuffer = [];
    let reconnectAttempts = 0;
    const MAX_LOGS = 50; // ë¡œê·¸ ìˆ˜ ì œí•œ
    const MAX_RECONNECT_ATTEMPTS = 5; // ì¬ì—°ê²° ì‹œë„ ì œí•œ

    // ë¡œê·¸ í‘œì‹œ ìƒíƒœ ë³€ìˆ˜ ì¶”ê°€
    let isLogsVisible = false;

    // DOM ìš”ì†Œë“¤ (ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°)
    const logContainer = document.getElementById('log-container');
    const logCardBody = document.getElementById('log-card-body');
    const toggleLogsBtn = document.getElementById('toggle-logs-btn');
    const tickerSelector = document.getElementById('ticker-selector');
    const strategyFilter = document.getElementById('strategy-filter');
    const tickerFilter = document.getElementById('ticker-filter');
    const connectionStatus = document.getElementById('connection-status');
    const refreshLogsBtn = document.getElementById('refresh-logs-btn');
    const autoRefreshToggle = document.getElementById('auto-refresh-toggle');

    // ìƒíƒœ ë³€ìˆ˜ë“¤
    let selectedTicker = '';
    let selectedStrategy = '';
    let isInitialized = false;

    // ===== ì´ˆê¸°í™” (í•œ ë²ˆë§Œ ì‹¤í–‰) =====
    if (!isInitialized) {
        init();
        isInitialized = true;
    }

    function init() {
        try {
            loadActiveTickers();
            loadTradeRecords();
            attachEventListeners();
            console.log('ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì™„ë£Œ (ë¡œê·¸ëŠ” ìˆ¨ê¹€ ìƒíƒœ)');
        } catch (error) {
            console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            showNotification('error', 'í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ===== ë¡œê·¸ í† ê¸€ ê¸°ëŠ¥ =====
    function toggleLogs() {
        isLogsVisible = !isLogsVisible;

        if (isLogsVisible) {
            // ë¡œê·¸ ë³´ì´ê¸°
            logCardBody.style.display = 'block';
            connectionStatus.style.display = 'inline-block';
            tickerSelector.style.display = 'inline-block';
            refreshLogsBtn.style.display = 'inline-block';
            autoRefreshToggle.style.display = 'inline-block';

            toggleLogsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> ë¡œê·¸ ìˆ¨ê¸°ê¸°';
            toggleLogsBtn.classList.remove('btn-outline-primary');
            toggleLogsBtn.classList.add('btn-outline-secondary');

            // WebSocket ì´ˆê¸°í™” ë° ë¡œê·¸ ë¡œë“œ
            if (!isWebSocketEnabled) {
                initWebSocket();
            }
            loadLogs();
            startAutoRefresh();

        } else {
            // ë¡œê·¸ ìˆ¨ê¸°ê¸°
            logCardBody.style.display = 'none';
            connectionStatus.style.display = 'none';
            tickerSelector.style.display = 'none';
            refreshLogsBtn.style.display = 'none';
            autoRefreshToggle.style.display = 'none';

            toggleLogsBtn.innerHTML = '<i class="fas fa-eye"></i> ë¡œê·¸ ë³´ê¸°';
            toggleLogsBtn.classList.remove('btn-outline-secondary');
            toggleLogsBtn.classList.add('btn-outline-primary');

            // WebSocket ì—°ê²° ì¢…ë£Œ ë° ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
            if (socket && socket.connected) {
                socket.disconnect();
            }
            stopAutoRefresh();
        }
    }

    // ===== WebSocket ì´ˆê¸°í™” (ì¬ì—°ê²° ì œí•œ) =====
    function initWebSocket() {
        if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
            console.warn('ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. WebSocket ë¹„í™œì„±í™”');
            isWebSocketEnabled = false;
            updateConnectionStatus('disabled');
            return;
        }

        try {
            if (typeof io !== 'undefined') {
                // ê¸°ì¡´ ì†Œì¼“ ì •ë¦¬
                if (socket) {
                    socket.disconnect();
                    socket = null;
                }

                socket = io({
                    timeout: 10000,
                    forceNew: true,
                    reconnection: false // ìë™ ì¬ì—°ê²° ë¹„í™œì„±í™”
                });

                setupWebSocketEvents();
                isWebSocketEnabled = true;
                reconnectAttempts++;
                console.log('WebSocket ì´ˆê¸°í™” ì™„ë£Œ');
            } else {
                console.warn('Socket.IO ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                isWebSocketEnabled = false;
                updateConnectionStatus('disabled');
            }
        } catch (error) {
            console.error('WebSocket ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            isWebSocketEnabled = false;
            updateConnectionStatus('error');
        }
    }

    // ===== WebSocket ì´ë²¤íŠ¸ ì„¤ì • =====
    function setupWebSocketEvents() {
        if (!socket) return;

        socket.on('connect', function() {
            console.log('WebSocket ì—°ê²°ë¨');
            isWebSocketConnected = true;
            reconnectAttempts = 0; // ì„±ê³µ ì‹œ ì¬ì„¤ì •
            updateConnectionStatus('connected');

            // ì•ˆì „í•œ ë°ì´í„° ìš”ì²­
            setTimeout(() => {
                if (socket && socket.connected) {
                    socket.emit('request_recent_logs', {
                        ticker: selectedTicker,
                        limit: MAX_LOGS
                    });
                    subscribeToLogs(selectedTicker);
                }
            }, 100);
        });

        socket.on('disconnect', function() {
            console.log('WebSocket ì—°ê²° ëŠê¹€');
            isWebSocketConnected = false;
            updateConnectionStatus('disconnected');
        });

        socket.on('recent_logs', function(data) {
            try {
                if (data && data.logs && Array.isArray(data.logs)) {
                    logBuffer = data.logs.slice(0, MAX_LOGS).reverse();
                    updateLogDisplay();
                }
            } catch (error) {
                console.error('ë¡œê·¸ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            }
        });

        socket.on('new_log', function(logEntry) {
            try {
                if (logEntry && logEntry.message) {
                    addNewLog(logEntry);
                }
            } catch (error) {
                console.error('ìƒˆ ë¡œê·¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            }
        });

        socket.on('error', function(data) {
            console.error('WebSocket ì˜¤ë¥˜:', data);
            showNotification('error', data.message || 'WebSocket ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });

        // ì—°ê²° íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
        setTimeout(() => {
            if (!isWebSocketConnected) {
                console.warn('WebSocket ì—°ê²° íƒ€ì„ì•„ì›ƒ');
                updateConnectionStatus('error');
            }
        }, 15000);
    }

    // ===== ë©”ëª¨ë¦¬ ì•ˆì „í•œ ë¡œê·¸ ì¶”ê°€ =====
    function addNewLog(logEntry) {
        try {
            logBuffer.push(logEntry);

            // ë©”ëª¨ë¦¬ ë³´í˜¸: ìµœëŒ€ ë¡œê·¸ ìˆ˜ ì œí•œ
            if (logBuffer.length > MAX_LOGS) {
                logBuffer = logBuffer.slice(-MAX_LOGS);
            }

            updateLogDisplay();
            scrollToBottom();
        } catch (error) {
            console.error('ë¡œê·¸ ì¶”ê°€ ì˜¤ë¥˜:', error);
        }
    }

    // ===== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì¤‘ë³µ ë°©ì§€) =====
    function attachEventListeners() {
        // ë¡œê·¸ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
        if (toggleLogsBtn) {
            toggleLogsBtn.addEventListener('click', toggleLogs);
        }

        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ì€ ë¡œê·¸ê°€ ë³´ì¼ ë•Œë§Œ ì‘ë™í•˜ë„ë¡ ì¡°ê±´ë¶€ ì²˜ë¦¬
        if (tickerSelector) {
            tickerSelector.addEventListener('change', function() {
                if (isLogsVisible) {
                    selectedTicker = this.value;
                    loadLogs();
                    subscribeToLogs(selectedTicker);
                }
            });
        }

        if (refreshLogsBtn) {
            refreshLogsBtn.addEventListener('click', function() {
                if (isLogsVisible) {
                    loadLogs();
                }
            });
        }

        if (autoRefreshToggle) {
            autoRefreshToggle.addEventListener('click', function() {
                if (isLogsVisible) {
                    toggleAutoRefresh();
                }
            });
        }

        // ê±°ë˜ ê¸°ë¡ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ (í•­ìƒ í™œì„±)
        if (tickerFilter) {
            tickerFilter.addEventListener('change', function() {
                selectedTicker = this.value;
                loadTradeRecords();
            });
        }

        if (strategyFilter) {
            strategyFilter.addEventListener('change', function() {
                selectedStrategy = this.value;
                loadTradeRecords();
            });
        }

        const refreshTradesBtn = document.getElementById('refresh-trades-btn');
        if (refreshTradesBtn) {
            refreshTradesBtn.addEventListener('click', loadTradeRecords);
        }

        // ë´‡ ì¤‘ì§€ ë²„íŠ¼ë“¤
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('stop-bot')) {
                const ticker = e.target.getAttribute('data-ticker');
                if (ticker && confirm(`${ticker} ë´‡ì„ ì •ë§ ì¤‘ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    stopBot(ticker);
                }
            }
        });
    }

    // ===== ìë™ ìƒˆë¡œê³ ì¹¨ ê´€ë¦¬ =====
    function startAutoRefresh() {
        if (!isLogsVisible) return;

        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }

        if (isAutoRefresh) {
            autoRefreshInterval = setInterval(() => {
                if (isLogsVisible && !isWebSocketConnected) {
                    loadLogs();
                }
            }, 5000);
        }
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    function toggleAutoRefresh() {
        isAutoRefresh = !isAutoRefresh;
        const btn = autoRefreshToggle;

        if (isAutoRefresh) {
            btn.innerHTML = '<i class="fas fa-pause"></i> ìë™ ìƒˆë¡œê³ ì¹¨';
            btn.classList.remove('btn-outline-danger');
            btn.classList.add('btn-outline-secondary');
            startAutoRefresh();
        } else {
            btn.innerHTML = '<i class="fas fa-play"></i> ìˆ˜ë™ ëª¨ë“œ';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-outline-danger');
            stopAutoRefresh();
        }
    }

    // ===== ë‚˜ë¨¸ì§€ ê¸°ëŠ¥ë“¤ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ =====
    function loadLogs() {
        if (!isLogsVisible) return;

        try {
            const url = selectedTicker ? `/logs/${selectedTicker}` : '/logs/all';

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.logs && Array.isArray(data.logs)) {
                        logBuffer = data.logs.slice(0, MAX_LOGS).reverse();
                        updateLogDisplay();
                    } else {
                        throw new Error('ì˜ëª»ëœ ë¡œê·¸ ë°ì´í„° í˜•ì‹');
                    }
                })
                .catch(error => {
                    console.error('ë¡œê·¸ ë¡œë”© ì˜¤ë¥˜:', error);
                    if (logContainer) {
                        logContainer.innerHTML = `
                            <div class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}
                            </div>
                        `;
                    }
                });
        } catch (error) {
            console.error('ë¡œê·¸ ë¡œë”© ìš”ì²­ ì˜¤ë¥˜:', error);
        }
    }

    function updateLogDisplay() {
        if (!logContainer || !isLogsVisible) return;

        try {
            if (logBuffer.length === 0) {
                logContainer.innerHTML = '<div class="text-center text-muted">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const logHtml = logBuffer.map(log => {
                const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString('ko-KR') : '';
                const level = log.level || 'INFO';
                const ticker = log.ticker || '';
                const message = log.message || '';

                const levelClass = {
                    'ERROR': 'text-danger',
                    'WARNING': 'text-warning',
                    'INFO': 'text-info',
                    'DEBUG': 'text-secondary'
                }[level] || 'text-dark';

                return `
                    <div class="log-entry mb-1" style="border-left: 3px solid ${level === 'ERROR' ? '#dc3545' : level === 'WARNING' ? '#ffc107' : '#0dcaf0'}; padding-left: 8px;">
                        <small class="text-muted">[${timestamp}]</small>
                        ${ticker ? `<span class="badge bg-secondary me-1">${ticker}</span>` : ''}
                        <span class="badge bg-light text-dark me-1">${level}</span>
                        <span class="${levelClass}">${message}</span>
                    </div>
                `;
            }).join('');

            logContainer.innerHTML = logHtml;
            scrollToBottom();

        } catch (error) {
            console.error('ë¡œê·¸ í‘œì‹œ ì˜¤ë¥˜:', error);
            logContainer.innerHTML = '<div class="text-center text-danger">ë¡œê·¸ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    function scrollToBottom() {
        if (logContainer && isLogsVisible) {
            try {
                logContainer.scrollTop = logContainer.scrollHeight;
            } catch (error) {
                console.error('ìŠ¤í¬ë¡¤ ì˜¤ë¥˜:', error);
            }
        }
    }

    function subscribeToLogs(ticker) {
        if (!socket || !socket.connected || !isLogsVisible) return;

        try {
            socket.emit('subscribe_logs', { ticker: ticker || '' });
        } catch (error) {
            console.error('ë¡œê·¸ êµ¬ë… ì˜¤ë¥˜:', error);
        }
    }

    function updateConnectionStatus(status) {
        if (!connectionStatus) return;

        const statusConfig = {
            'connected': { class: 'bg-success', icon: 'text-white', text: 'ì—°ê²°ë¨' },
            'disconnected': { class: 'bg-danger', icon: 'text-white', text: 'ì—°ê²° ëŠê¹€' },
            'connecting': { class: 'bg-warning', icon: 'text-dark', text: 'ì—°ê²° ì¤‘...' },
            'disabled': { class: 'bg-secondary', icon: 'text-white', text: 'ë¹„í™œì„±í™”' },
            'error': { class: 'bg-danger', icon: 'text-white', text: 'ì˜¤ë¥˜' }
        };

        const config = statusConfig[status] || statusConfig['error'];

        connectionStatus.className = `badge ${config.class}`;
        connectionStatus.innerHTML = `<i class="fas fa-circle ${config.icon}"></i> ${config.text}`;
    }

    // ===== ê¸°ì¡´ í•¨ìˆ˜ë“¤ (loadActiveTickers, loadTradeRecords, stopBot, showNotification ë“±) =====
    function loadActiveTickers() {
        fetch('/api/active-tickers')
            .then(response => response.json())
            .then(data => {
                if (data && data.tickers && Array.isArray(data.tickers)) {
                    updateTickerSelectors(data.tickers);
                }
            })
            .catch(error => {
                console.error('í™œì„± í‹°ì»¤ ë¡œë”© ì˜¤ë¥˜:', error);
            });
    }

    function updateTickerSelectors(tickers) {
        const selectors = [tickerSelector, tickerFilter];

        selectors.forEach(selector => {
            if (selector) {
                const currentValue = selector.value;
                selector.innerHTML = '<option value="">ëª¨ë“  í‹°ì»¤</option>';

                tickers.forEach(ticker => {
                    const option = document.createElement('option');
                    option.value = ticker;
                    option.textContent = ticker;
                    selector.appendChild(option);
                });

                if (tickers.includes(currentValue)) {
                    selector.value = currentValue;
                }
            }
        });
    }

    function loadTradeRecords() {
        try {
            let url = '/api/trade-records';
            const params = new URLSearchParams();

            if (selectedTicker) params.append('ticker', selectedTicker);
            if (selectedStrategy) params.append('strategy', selectedStrategy);

            if (params.toString()) {
                url += '?' + params.toString();
            }

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateTradeRecordsDisplay(data);
                })
                .catch(error => {
                    console.error('ê±°ë˜ ê¸°ë¡ ë¡œë”© ì˜¤ë¥˜:', error);
                    const container = document.getElementById('trade-records-container');
                    if (container) {
                        container.innerHTML = `
                            <div class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ê±°ë˜ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                        `;
                    }
                });
        } catch (error) {
            console.error('ê±°ë˜ ê¸°ë¡ ìš”ì²­ ì˜¤ë¥˜:', error);
        }
    }

    function updateTradeRecordsDisplay(data) {
        const container = document.getElementById('trade-records-container');
        if (!container) return;

        try {
            if (!data || !data.trades || data.trades.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">ê±°ë˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let filterText = 'ì˜¤ëŠ˜ì˜ ëª¨ë“  ê±°ë˜';
            if (selectedTicker && selectedStrategy) {
                filterText = `${selectedTicker} (${getStrategyName(selectedStrategy)}) ê±°ë˜`;
            } else if (selectedTicker) {
                filterText = `${selectedTicker} ê±°ë˜`;
            } else if (selectedStrategy) {
                filterText = `${getStrategyName(selectedStrategy)} ê±°ë˜`;
            }

            const titleElement = document.getElementById('trade-records-title');
            if (titleElement) {
                titleElement.textContent = `(${filterText})`;
            }

            const tradesHtml = data.trades.map(trade => {
                const profitClass = trade.profit > 0 ? 'text-success' : trade.profit < 0 ? 'text-danger' : 'text-muted';
                const profitIcon = trade.profit > 0 ? 'ğŸ“ˆ' : trade.profit < 0 ? 'ğŸ“‰' : 'â–';

                return `
                    <div class="row border-bottom py-2 align-items-center">
                        <div class="col-md-2">
                            <strong>${trade.ticker}</strong>
                            <br><small class="text-muted">${trade.timestamp}</small>
                        </div>
                        <div class="col-md-2">
                            <span class="badge ${trade.action === 'BUY' ? 'bg-success' : 'bg-danger'}">
                                ${trade.action === 'BUY' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'}
                            </span>
                            <br><small class="text-muted">${getStrategyName(trade.strategy)}</small>
                        </div>
                        <div class="col-md-2">
                            <strong>â‚©${trade.price.toLocaleString()}</strong>
                            <br><small class="text-muted">${trade.quantity} ê°œ</small>
                        </div>
                        <div class="col-md-2">
                            <strong>â‚©${trade.amount.toLocaleString()}</strong>
                        </div>
                        <div class="col-md-2">
                            <span class="${profitClass}">
                                ${profitIcon} ${trade.profit > 0 ? '+' : ''}${trade.profit.toFixed(2)}%
                            </span>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">${trade.reason}</small>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="row border-bottom bg-light py-2 fw-bold">
                    <div class="col-md-2">ì½”ì¸/ì‹œê°„</div>
                    <div class="col-md-2">ê±°ë˜/ì „ëµ</div>
                    <div class="col-md-2">ê°€ê²©/ìˆ˜ëŸ‰</div>
                    <div class="col-md-2">ê±°ë˜ê¸ˆì•¡</div>
                    <div class="col-md-2">ìˆ˜ìµë¥ </div>
                    <div class="col-md-2">ì‚¬ìœ </div>
                </div>
                ${tradesHtml}
            `;

        } catch (error) {
            console.error('ê±°ë˜ ê¸°ë¡ í‘œì‹œ ì˜¤ë¥˜:', error);
            container.innerHTML = '<div class="text-center text-danger">ê±°ë˜ ê¸°ë¡ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    function getStrategyName(strategy) {
        const names = {
            'rsi': 'ğŸ“ˆ RSI',
            'adaptive': 'ğŸ¯ ì–´ëŒ‘í‹°ë¸Œ',
            'ensemble': 'ğŸ”¥ ì•™ìƒë¸”',
            'volatility': 'ğŸš€ ë³€ë™ì„±',
            'bollinger': 'ğŸ“Š ë³¼ë¦°ì €'
        };
        return names[strategy] || strategy;
    }

    function stopBot(ticker) {
        fetch('/stop-bot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ticker: ticker })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('success', `${ticker} ë´‡ì´ ì„±ê³µì ìœ¼ë¡œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification('error', data.error || 'ë´‡ ì¤‘ì§€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('ë´‡ ì¤‘ì§€ ì˜¤ë¥˜:', error);
            showNotification('error', 'ë´‡ ì¤‘ì§€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    function showNotification(type, message) {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;

        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
        const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle';

        const toastHtml = `
            <div id="${toastId}" class="toast ${bgClass} text-white" role="alert">
                <div class="d-flex align-items-center p-3">
                    <i class="fas fa-${icon} me-2"></i>
                    <div class="toast-body flex-grow-1">${message}</div>
                    <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);

        const toastElement = document.getElementById(toastId);
        if (toastElement) {
            const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
            toast.show();

            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
    }

    // ===== í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬ =====
    window.addEventListener('beforeunload', function() {
        try {
            if (socket && socket.connected) {
                socket.disconnect();
            }
            stopAutoRefresh();
        } catch (error) {
            console.error('ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
        }
    });
});
</script>
{% endblock %}