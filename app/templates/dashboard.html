
{% extends "base.html" %}

{% block content %}
<!-- ê¸°ì¡´ HTML êµ¬ì¡°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ -->
<h2>ê±°ë˜ ëŒ€ì‹œë³´ë“œ</h2>

<!-- ì „ëµë³„ ìš”ì•½ ì •ë³´ ì¹´ë“œ -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">í™œì„± ì „ëµ í˜„í™©</h5>
            </div>
            <div class="card-body">
                {% if trading_bots %}
                <div class="row">
                    {% for ticker, bot_info in trading_bots.items() %}
                    <div class="col-md-4 mb-3">
                        <div class="card border-{% if bot_info.running %}success{% else %}danger{% endif %}">
                            <div class="card-body">
                                <h6 class="card-title">
                                    {{ ticker }}
                                    {% if bot_info.running %}
                                    <span class="badge bg-success">ì‹¤í–‰ì¤‘</span>
                                    {% else %}
                                    <span class="badge bg-danger">ì¤‘ì§€ë¨</span>
                                    {% endif %}
                                </h6>
                                <p class="card-text">
                                    <strong>ì „ëµ:</strong>
                                    {% if bot_info.strategy == 'rsi' %}
                                    ğŸ“ˆ RSI ì „ëµ
                                    {% elif bot_info.strategy == 'adaptive' %}
                                    ğŸ¯ ì–´ëŒ‘í‹°ë¸Œ ì „ëµ
                                    {% elif bot_info.strategy == 'ensemble' %}
                                    ğŸ”¥ ì•™ìƒë¸” ì „ëµ
                                    {% elif bot_info.strategy == 'volatility' %}
                                    ğŸš€ ë³€ë™ì„± ëŒíŒŒ
                                    {% else %}
                                    ğŸ“Š ë³¼ë¦°ì € ë°´ë“œ
                                    {% endif %}
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        {% if bot_info.last_signal_time %}
                                        ìµœê·¼: {{ bot_info.last_signal_time }}
                                        {% else %}
                                        ì‹ í˜¸ ëŒ€ê¸° ì¤‘
                                        {% endif %}
                                    </small>
                                    {% if bot_info.running %}
                                    <button class="btn btn-sm btn-outline-danger stop-bot" data-ticker="{{ ticker }}">
                                        ì¤‘ì§€
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center">
                    <p class="mb-3">ì‹¤í–‰ ì¤‘ì¸ ë´‡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    <a href="/settings" class="btn btn-primary">ìƒˆ ë´‡ ì‹œì‘í•˜ê¸°</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ì”ê³  ë° ì„±ê³¼ ì •ë³´ -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                ğŸ’° ì”ê³  ì •ë³´
            </div>
            <div class="card-body">
                <p><strong>ë³´ìœ  í˜„ê¸ˆ:</strong> {{ "â‚©{:,.0f}".format(balance_info.cash|default(0)) }}</p>
                <p><strong>ì´ ìì‚°:</strong> {{ "â‚©{:,.0f}".format(balance_info.total_balance|default(0)) }}</p>
                {% if balance_info.coins %}
                <hr>
                <h6>ë³´ìœ  ì½”ì¸:</h6>
                {% for coin in balance_info.coins %}
                <small>{{ coin.ticker }}: {{ "{:.4f}".format(coin.balance) }}</small><br>
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                ğŸ“Š ì˜¤ëŠ˜ì˜ ì„±ê³¼
            </div>
            <div class="card-body">
                {% if daily_stats %}
                <p><strong>ì´ ê±°ë˜ íšŸìˆ˜:</strong> {{ daily_stats.total_trades|default(0) }}íšŒ</p>
                <p><strong>ì„±ê³µ ê±°ë˜:</strong> {{ daily_stats.successful_trades|default(0) }}íšŒ</p>
                <p><strong>ì˜¤ëŠ˜ ìˆ˜ìµë¥ :</strong>
                    <span class="{% if daily_stats.daily_return > 0 %}text-success{% elif daily_stats.daily_return < 0 %}text-danger{% endif %}">
                        {{ "{:+.2f}%".format(daily_stats.daily_return|default(0)) }}
                    </span>
                </p>
                <p><strong>ìŠ¹ë¥ :</strong> {{ "{:.1f}%".format(daily_stats.win_rate|default(0)) }}</p>
                {% else %}
                <p><strong>ì´ ê±°ë˜ íšŸìˆ˜:</strong> 0íšŒ</p>
                <p><strong>ì„±ê³µ ê±°ë˜:</strong> 0íšŒ</p>
                <p><strong>ì˜¤ëŠ˜ ìˆ˜ìµë¥ :</strong> <span class="text-muted">0.00%</span></p>
                <p><strong>ìŠ¹ë¥ :</strong> 0.0%</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                ğŸ¯ ì „ëµë³„ ì„±ê³¼
            </div>
            <div class="card-body">
                {% if strategy_performance %}
                {% for strategy, perf in strategy_performance.items() %}
                <div class="mb-2">
                    <small>
                        <strong>
                            {% if strategy == 'rsi' %}ğŸ“ˆ RSI
                            {% elif strategy == 'adaptive' %}ğŸ¯ ì–´ëŒ‘í‹°ë¸Œ
                            {% elif strategy == 'ensemble' %}ğŸ”¥ ì•™ìƒë¸”
                            {% elif strategy == 'volatility' %}ğŸš€ ë³€ë™ì„±
                            {% else %}ğŸ“Š ë³¼ë¦°ì €{% endif %}
                        :</strong>
                        <span class="{% if perf.return > 0 %}text-success{% elif perf.return < 0 %}text-danger{% endif %}">
                            {{ "{:+.2f}%".format(perf.return) }}
                        </span>
                        ({{ perf.trades }}íšŒ)
                    </small>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted">ì•„ì§ ê±°ë˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ì‹¤ì‹œê°„ ë¡œê·¸ (í—¤ë” ìˆ˜ì •) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>ğŸ“ ì‹¤ì‹œê°„ ë¡œê·¸</span>
                <div class="d-flex gap-2 align-items-center">
                    <span id="connection-status" class="badge bg-secondary">
                        <i class="fas fa-circle text-warning"></i> ì—°ê²° ì¤‘...
                    </span>
                    <select id="ticker-selector" class="form-select form-select-sm" style="width: 120px;">
                        <option value="">ëª¨ë“  í‹°ì»¤</option>
                    </select>
                    <button id="refresh-logs-btn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button id="auto-refresh-toggle" class="btn btn-sm btn-outline-secondary" data-auto="true">
                        <i class="fas fa-pause"></i> ìë™ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="log-container" style="height: 350px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; font-family: 'Courier New', monospace; font-size: 0.9em; border-radius: 5px;">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ê±°ë˜ ê¸°ë¡ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>ğŸ“ˆ ê±°ë˜ ê¸°ë¡ <span id="trade-records-title">(ì˜¤ëŠ˜ì˜ ëª¨ë“  ê±°ë˜)</span></span>
                <div class="d-flex gap-2">
                    <select id="ticker-filter" class="form-select form-select-sm" style="width: 120px;">
                        <option value="">ëª¨ë“  í‹°ì»¤</option>
                    </select>
                    <select id="strategy-filter" class="form-select form-select-sm" style="width: 120px;">
                        <option value="">ëª¨ë“  ì „ëµ</option>
                        <option value="rsi">ğŸ“ˆ RSI</option>
                        <option value="adaptive">ğŸ¯ ì–´ëŒ‘í‹°ë¸Œ</option>
                        <option value="ensemble">ğŸ”¥ ì•™ìƒë¸”</option>
                        <option value="volatility">ğŸš€ ë³€ë™ì„±</option>
                        <option value="bollinger">ğŸ“Š ë³¼ë¦°ì €</option>
                    </select>
                    <button id="refresh-trades-btn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="trade-records-container">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>ê±°ë˜ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;"></div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== WebSocket ê´€ë ¨ ë³€ìˆ˜ =====
    let socket = null;
    let isWebSocketEnabled = false;
    let isWebSocketConnected = false;

    // ===== ê¸°ì¡´ ë³€ìˆ˜ë“¤ ìœ ì§€ =====
    const logContainer = document.getElementById('log-container');
    const tickerSelector = document.getElementById('ticker-selector');
    const strategyFilter = document.getElementById('strategy-filter');
    const tickerFilter = document.getElementById('ticker-filter');
    const tradeRecordsTitle = document.getElementById('trade-records-title');
    const refreshLogsBtn = document.getElementById('refresh-logs-btn');
    const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
    const refreshTradesBtn = document.getElementById('refresh-trades-btn');
    const connectionStatus = document.getElementById('connection-status');

    // ìƒíƒœ ë³€ìˆ˜ë“¤
    let selectedTicker = '';
    let selectedStrategy = '';
    let autoRefreshInterval = null;
    let isAutoRefresh = true;
    let logBuffer = [];  // WebSocketìš© ë¡œê·¸ ë²„í¼
    const MAX_LOGS = 100;

    // ===== ì´ˆê¸°í™” =====
    init();

    function init() {
        // WebSocket ì—°ê²° ì‹œë„
        initWebSocket();

        // ê¸°ì¡´ ì´ˆê¸°í™”
        loadActiveTickers();
        loadLogs();
        loadTradeRecords();
        startAutoRefresh();
        attachEventListeners();
    }

    // ===== WebSocket ì´ˆê¸°í™” =====
    function initWebSocket() {
        try {
            if (typeof io !== 'undefined') {
                socket = io();
                setupWebSocketEvents();
                isWebSocketEnabled = true;
                console.log('WebSocket í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”ë¨');
            } else {
                console.warn('Socket.IO ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ. ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.');
                isWebSocketEnabled = false;
                updateConnectionStatus('disabled');
            }
        } catch (error) {
            console.error('WebSocket ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            isWebSocketEnabled = false;
            updateConnectionStatus('error');
        }
    }

    // ===== WebSocket ì´ë²¤íŠ¸ ì„¤ì • =====
    function setupWebSocketEvents() {
        if (!socket) return;

        socket.on('connect', function() {
            console.log('WebSocket ì—°ê²°ë¨');
            isWebSocketConnected = true;
            updateConnectionStatus('connected');

            // ìµœê·¼ ë¡œê·¸ ìš”ì²­
            socket.emit('request_recent_logs', {
                ticker: selectedTicker,
                limit: 50
            });

            // ë¡œê·¸ êµ¬ë… ì‹œì‘
            subscribeToLogs(selectedTicker);
        });

        socket.on('disconnect', function() {
            console.log('WebSocket ì—°ê²° ëŠê¹€');
            isWebSocketConnected = false;
            updateConnectionStatus('disconnected');
        });

        socket.on('status', function(data) {
            console.log('WebSocket ìƒíƒœ:', data.message);
            showNotification('info', data.message);
        });

        socket.on('recent_logs', function(data) {
            console.log('ìµœê·¼ ë¡œê·¸ ìˆ˜ì‹ :', data.logs.length, 'ê°œ');
            if (data.logs && data.logs.length > 0) {
                logBuffer = data.logs.slice().reverse();
                updateLogDisplay();
            }
        });

        socket.on('new_log', function(logEntry) {
            console.log('ìƒˆ ë¡œê·¸ ìˆ˜ì‹ :', logEntry);
            addNewLog(logEntry);
        });

        socket.on('error', function(data) {
            console.error('WebSocket ì˜¤ë¥˜:', data.message);
            showNotification('error', data.message);
        });
    }

    // ===== ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸ =====
    function updateConnectionStatus(status) {
        if (!connectionStatus) return;

        switch(status) {
            case 'connected':
                connectionStatus.className = 'badge bg-success';
                connectionStatus.innerHTML = '<i class="fas fa-circle text-light"></i> ì‹¤ì‹œê°„ ì—°ê²°ë¨';
                break;
            case 'disconnected':
                connectionStatus.className = 'badge bg-danger';
                connectionStatus.innerHTML = '<i class="fas fa-circle text-light"></i> ì—°ê²° ëŠê¹€';
                break;
            case 'connecting':
                connectionStatus.className = 'badge bg-warning';
                connectionStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì—°ê²° ì¤‘...';
                break;
            case 'disabled':
                connectionStatus.className = 'badge bg-secondary';
                connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> ê¸°ë³¸ ëª¨ë“œ';
                break;
            case 'error':
                connectionStatus.className = 'badge bg-danger';
                connectionStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ì—°ê²° ì˜¤ë¥˜';
                break;
        }
    }

    // ===== WebSocket ë¡œê·¸ êµ¬ë… =====
    function subscribeToLogs(ticker) {
        if (isWebSocketConnected && socket) {
            socket.emit('subscribe_logs', { ticker: ticker });
        }
    }

    // ===== ìƒˆ ë¡œê·¸ ì¶”ê°€ (WebSocket) =====
    function addNewLog(logEntry) {
        logBuffer.push(logEntry);

        if (logBuffer.length > MAX_LOGS) {
            logBuffer = logBuffer.slice(-MAX_LOGS);
        }

        updateLogDisplay();
        scrollToBottom();

        // ì¤‘ìš”í•œ ë¡œê·¸ ì•Œë¦¼
        if (logEntry.level === 'ERROR') {
            showNotification('error', logEntry.message);
        } else if (logEntry.level === 'WARNING') {
            showNotification('warning', logEntry.message);
        }
    }

    // ===== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° =====
    function attachEventListeners() {
        // ë´‡ ì¤‘ì§€ ë²„íŠ¼
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('stop-bot')) {
                const ticker = e.target.getAttribute('data-ticker');
                stopBot(ticker, e.target);
            }
        });

        // í‹°ì»¤ ì„ íƒê¸° ë³€ê²½
        if (tickerSelector) {
            tickerSelector.addEventListener('change', function() {
                selectedTicker = this.value;

                if (isWebSocketConnected) {
                    // WebSocket ëª¨ë“œ: êµ¬ë… ë³€ê²½
                    socket.emit('unsubscribe_logs');
                    setTimeout(() => {
                        socket.emit('request_recent_logs', {
                            ticker: selectedTicker,
                            limit: 50
                        });
                        subscribeToLogs(selectedTicker);
                    }, 100);
                } else {
                    // ê¸°ì¡´ ëª¨ë“œ: ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
                    loadLogs();
                }
            });
        }

        // í•„í„° ë³€ê²½
        if (strategyFilter) {
            strategyFilter.addEventListener('change', function() {
                selectedStrategy = this.value;
                loadTradeRecords();
            });
        }

        if (tickerFilter) {
            tickerFilter.addEventListener('change', function() {
                selectedTicker = this.value;
                loadTradeRecords();
            });
        }

        // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ (ìˆ˜ì •)
        if (refreshLogsBtn) {
            refreshLogsBtn.addEventListener('click', function() {
                if (isWebSocketConnected) {
                    // WebSocket ëª¨ë“œ: ìµœê·¼ ë¡œê·¸ ì¬ìš”ì²­
                    socket.emit('request_recent_logs', {
                        ticker: selectedTicker,
                        limit: 50
                    });
                } else {
                    // ê¸°ì¡´ ëª¨ë“œ: ê¸°ì¡´ ë¡œë“œ í•¨ìˆ˜ ì‚¬ìš©
                    loadLogs();
                }
            });
        }

        if (refreshTradesBtn) {
            refreshTradesBtn.addEventListener('click', loadTradeRecords);
        }

        // ìë™ ìƒˆë¡œê³ ì¹¨ í† ê¸€
        if (autoRefreshToggle) {
            autoRefreshToggle.addEventListener('click', toggleAutoRefresh);
        }
    }

    // ===== ë¡œê·¸ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸ (í†µí•©) =====
    function updateLogDisplay(logs = null) {
        if (!logContainer) return;

        // WebSocket ëª¨ë“œì™€ ê¸°ì¡´ ëª¨ë“œ í†µí•©
        const logsToDisplay = logs || logBuffer;

        if (!logsToDisplay || logsToDisplay.length === 0) {
            logContainer.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    í‘œì‹œí•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
            `;
            return;
        }

        const logHtml = logsToDisplay.map(log => {
            const levelClass = {
                'INFO': 'text-info',
                'WARNING': 'text-warning',
                'ERROR': 'text-danger',
                'DEBUG': 'text-muted'
            }[log.level] || 'text-dark';

            const levelIcon = {
                'INFO': 'fas fa-info-circle',
                'WARNING': 'fas fa-exclamation-triangle',
                'ERROR': 'fas fa-times-circle',
                'DEBUG': 'fas fa-bug'
            }[log.level] || 'fas fa-circle';

            // WebSocket ë¡œê·¸ì™€ ê¸°ì¡´ ë¡œê·¸ êµ¬ì¡° í˜¸í™˜
            const timeAgo = log.raw_timestamp ? getTimeAgo(log.raw_timestamp) : '';

            return `
                <div class="log-entry mb-2 p-2 border-bottom border-light">
                    <div class="d-flex align-items-start">
                        <span class="text-muted me-2 small">${log.timestamp}</span>
                        <span class="badge bg-secondary me-2">
                            <i class="${levelIcon} me-1"></i>${log.level}
                        </span>
                        ${timeAgo ? `<span class="text-muted small ms-auto">${timeAgo}</span>` : ''}
                    </div>
                    <div class="${levelClass} mt-1" style="word-break: break-word;">
                        ${log.message}
                    </div>
                </div>
            `;
        }).join('');

        logContainer.innerHTML = logHtml;
        scrollToBottom();
    }

    // ===== ê¸°ì¡´ í•¨ìˆ˜ë“¤ ìœ ì§€ =====
    function loadActiveTickers() {
        fetch('/api/active_tickers')
            .then(response => response.json())
            .then(tickers => {
                updateTickerSelectors(tickers);
            })
            .catch(error => {
                console.error('í™œì„± í‹°ì»¤ ë¡œë“œ ì˜¤ë¥˜:', error);
            });
    }

    function updateTickerSelectors(tickers) {
        const selectors = [tickerSelector, tickerFilter];

        selectors.forEach(selector => {
            if (selector) {
                const defaultOption = selector.querySelector('option[value=""]');
                selector.innerHTML = '';
                if (defaultOption) {
                    selector.appendChild(defaultOption);
                }

                tickers.forEach(ticker => {
                    const option = document.createElement('option');
                    option.value = ticker;
                    option.textContent = ticker;
                    selector.appendChild(option);
                });
            }
        });
    }

    function loadLogs() {
        const url = selectedTicker ? `/api/logs/${selectedTicker}` : '/api/logs';

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(logs => {
                // WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
                if (!isWebSocketConnected) {
                    updateLogDisplay(logs);
                }
            })
            .catch(error => {
                console.error('ë¡œê·¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                if (logContainer && !isWebSocketConnected) {
                    logContainer.innerHTML = `
                        <div class="text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                        </div>
                    `;
                }
            });
    }

    // ===== ë‚˜ë¨¸ì§€ ê¸°ì¡´ í•¨ìˆ˜ë“¤ ê·¸ëŒ€ë¡œ ìœ ì§€ =====
    function loadTradeRecords() {
        let url = '/api/trade_records';
        const params = new URLSearchParams();

        if (selectedTicker) params.append('ticker', selectedTicker);
        if (selectedStrategy) params.append('strategy', selectedStrategy);

        if (params.toString()) {
            url += '?' + params.toString();
        }

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(records => {
                updateTradeRecordsTable(records);
                updateTradeRecordsTitle();
            })
            .catch(error => {
                console.error('ê±°ë˜ ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                const container = document.getElementById('trade-records-container');
                if (container) {
                    container.innerHTML = `
                        <div class="text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ê±°ë˜ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                        </div>
                    `;
                }
            });
    }

    function updateTradeRecordsTitle() {
        if (!tradeRecordsTitle) return;

        let titleText = '(ì˜¤ëŠ˜ì˜ ';
        if (selectedTicker && selectedStrategy) {
            titleText += `${selectedTicker} ${getStrategyDisplayName(selectedStrategy)} `;
        } else if (selectedTicker) {
            titleText += `${selectedTicker} `;
        } else if (selectedStrategy) {
            titleText += `${getStrategyDisplayName(selectedStrategy)} `;
        } else {
            titleText += 'ëª¨ë“  ';
        }
        titleText += 'ê±°ë˜)';
        tradeRecordsTitle.textContent = titleText;
    }

    function getStrategyDisplayName(strategy) {
        const strategyNames = {
            'rsi': 'RSI',
            'adaptive': 'ì–´ëŒ‘í‹°ë¸Œ',
            'ensemble': 'ì•™ìƒë¸”',
            'volatility': 'ë³€ë™ì„±',
            'bollinger': 'ë³¼ë¦°ì €'
        };
        return strategyNames[strategy] || strategy;
    }

    function updateTradeRecordsTable(records) {
        const container = document.getElementById('trade-records-container');
        if (!container) return;

        if (!records || records.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    í•´ë‹¹ ì¡°ê±´ì˜ ê±°ë˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                    <br><small>ë‹¤ë¥¸ í•„í„° ì¡°ê±´ì„ ì‹œë„í•´ë³´ì„¸ìš”.</small>
                </div>
            `;
            return;
        }

        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ë‚ ì§œ/ì‹œê°„</th>
                            <th>í‹°ì»¤</th>
                            <th>ì „ëµ</th>
                            <th>ìœ í˜•</th>
                            <th>ê°€ê²©</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>ê¸ˆì•¡</th>
                            <th>ìˆ˜ìµë¥ </th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        records.forEach(record => {
            const tradeType = record.trade_type === 'BUY' ?
                '<span class="badge bg-primary">ë§¤ìˆ˜</span>' :
                '<span class="badge bg-danger">ë§¤ë„</span>';

            const profitLoss = record.profit_loss !== null ?
                `<span class="${record.profit_loss > 0 ? 'text-success' : 'text-danger'}">
                    ${record.profit_loss > 0 ? '+' : ''}${parseFloat(record.profit_loss).toFixed(2)}%
                </span>` : '-';

            tableHtml += `
                <tr>
                    <td>${record.timestamp}</td>
                    <td>${record.ticker}</td>
                    <td>${getStrategyBadge(record.strategy)}</td>
                    <td>${tradeType}</td>
                    <td>â‚©${Number(record.price).toLocaleString()}</td>
                    <td>${parseFloat(record.volume).toFixed(4)}</td>
                    <td>â‚©${Number(record.amount).toLocaleString()}</td>
                    <td>${profitLoss}</td>
                </tr>
            `;
        });

        tableHtml += '</tbody></table></div>';
        container.innerHTML = tableHtml;
    }

    function getStrategyBadge(strategy) {
        const badges = {
            'rsi': '<span class="badge bg-info">ğŸ“ˆ RSI</span>',
            'adaptive': '<span class="badge bg-success">ğŸ¯ ì–´ëŒ‘í‹°ë¸Œ</span>',
            'ensemble': '<span class="badge bg-warning">ğŸ”¥ ì•™ìƒë¸”</span>',
            'volatility': '<span class="badge bg-primary">ğŸš€ ë³€ë™ì„±</span>',
            'bollinger': '<span class="badge bg-secondary">ğŸ“Š ë³¼ë¦°ì €</span>'
        };
        return badges[strategy] || `<span class="badge bg-light text-dark">${strategy}</span>`;
    }

    function stopBot(ticker, buttonElement) {
        const originalText = buttonElement.textContent;
        buttonElement.disabled = true;
        buttonElement.textContent = 'ì¤‘ì§€ ì¤‘...';
        buttonElement.classList.add('btn-secondary');
        buttonElement.classList.remove('btn-outline-danger');

        fetch(`/api/stop_bot/${ticker}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                showNotification('success', data.message || `${ticker} ë´‡ì´ ì„±ê³µì ìœ¼ë¡œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('error', `ë´‡ ì¤‘ì§€ ì‹¤íŒ¨: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}`);
                restoreButton(buttonElement, originalText);
            }
        })
        .catch(error => {
            console.error('ë´‡ ì¤‘ì§€ ì˜¤ë¥˜:', error);
            const errorMessage = error.message.includes('HTTP')
                ? `ì„œë²„ ì˜¤ë¥˜: ${error.message}`
                : 'ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            showNotification('error', errorMessage);
            restoreButton(buttonElement, originalText);
        });
    }

    function restoreButton(buttonElement, originalText) {
        buttonElement.disabled = false;
        buttonElement.textContent = originalText;
        buttonElement.classList.remove('btn-secondary');
        buttonElement.classList.add('btn-outline-danger');
    }

    function showNotification(type, message) {
        const toastContainer = document.getElementById('toast-container');

        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'danger'} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'info' ? 'info-circle' : 'exclamation-triangle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);

        const toastElement = toastContainer.lastElementChild;
        const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: type === 'success' ? 3000 : 5000
        });
        toast.show();

        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    }

    function startAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }

        autoRefreshInterval = setInterval(() => {
            if (isAutoRefresh && !isWebSocketConnected) {
                // WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ìë™ ìƒˆë¡œê³ ì¹¨
                loadLogs();
                loadTradeRecords();
            }
        }, 10000);
    }

    function toggleAutoRefresh() {
        isAutoRefresh = !isAutoRefresh;
        const icon = autoRefreshToggle.querySelector('i');

        if (isAutoRefresh) {
            autoRefreshToggle.textContent = ' ìë™ ìƒˆë¡œê³ ì¹¨';
            autoRefreshToggle.classList.remove('btn-outline-success');
            autoRefreshToggle.classList.add('btn-outline-secondary');
            icon.className = 'fas fa-pause';
            autoRefreshToggle.setAttribute('data-auto', 'true');
        } else {
            autoRefreshToggle.textContent = ' ìë™ ìƒˆë¡œê³ ì¹¨';
            autoRefreshToggle.classList.remove('btn-outline-secondary');
            autoRefreshToggle.classList.add('btn-outline-success');
            icon.className = 'fas fa-play';
            autoRefreshToggle.setAttribute('data-auto', 'false');
        }
        autoRefreshToggle.prepend(icon);
    }

    function scrollToBottom() {
        if (logContainer) {
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    }

    function getTimeAgo(timestamp) {
        try {
            const now = new Date();
            const logTime = new Date(timestamp);
            const diffMs = now - logTime;
            const diffSecs = Math.floor(diffMs / 1000);

            if (diffSecs < 60) return `${diffSecs}ì´ˆ ì „`;
            if (diffSecs < 3600) return `${Math.floor(diffSecs / 60)}ë¶„ ì „`;
            if (diffSecs < 86400) return `${Math.floor(diffSecs / 3600)}ì‹œê°„ ì „`;
            return `${Math.floor(diffSecs / 86400)}ì¼ ì „`;
        } catch (e) {
            return 'ë°©ê¸ˆ ì „';
        }
    }

    // ì´ˆê¸° ì—°ê²° ìƒíƒœ í‘œì‹œ
    updateConnectionStatus('connecting');
});
</script>
{% endblock %}