{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- 헤더 카드 -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="text-primary mb-1">
                                <i class="fas fa-chart-line me-2"></i>
                                코인 수익성 분석 & 추천
                            </h2>
                            <p class="text-muted mb-0">AI 기반 다중 지표 분석으로 최적의 투자 기회를 찾아보세요</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button id="refreshBtn" class="btn btn-primary">
                                <i class="fas fa-sync-alt me-2"></i>새로고침
                            </button>
                            <button id="marketAnalysisBtn" class="btn btn-outline-info">
                                <i class="fas fa-chart-bar me-2"></i>시장 분석
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 컨트롤 패널 -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="limitSelect" class="form-label fw-semibold">
                                <i class="fas fa-list-ol me-1"></i>표시 개수
                            </label>
                            <select id="limitSelect" class="form-select">
                                <option value="5">상위 5개</option>
                                <option value="10" selected>상위 10개</option>
                                <option value="20">상위 20개</option>
                                <option value="30">상위 30개</option>
                                <option value="50">상위 50개</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="minScoreSelect" class="form-label fw-semibold">
                                <i class="fas fa-filter me-1"></i>최소 점수
                            </label>
                            <select id="minScoreSelect" class="form-select">
                                <option value="0">전체 (0점 이상)</option>
                                <option value="20">20점 이상</option>
                                <option value="30" selected>30점 이상</option>
                                <option value="40">40점 이상</option>
                                <option value="50">50점 이상</option>
                                <option value="60">60점 이상</option>
                                <option value="70">70점 이상</option>
                                <option value="80">80점 이상</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-clock me-1"></i>자동 업데이트
                            </label>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="autoRefresh">
                                <label class="form-check-label" for="autoRefresh">
                                    5분마다 새로고침
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-info-circle me-1"></i>상태
                            </label>
                            <div class="mt-2">
                                <span id="statusIndicator" class="badge bg-secondary">대기중</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 메인 콘텐츠 영역 -->
            <div class="main-content-area position-relative">
                <!-- 로딩 오버레이 -->
                <div id="loadingOverlay" class="position-absolute w-100 h-100 bg-white bg-opacity-75 d-flex align-items-center justify-content-center" style="display: none !important; z-index: 1000; min-height: 400px;">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5 class="text-primary">AI 분석 진행 중...</h5>
                        <p class="text-muted">시장 데이터를 분석하여 최적의 투자 기회를 찾고 있습니다.</p>
                    </div>
                </div>

                <!-- 분석 결과 요약 -->
                <div id="analysisSummary" class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card bg-gradient border-0 h-100 summary-card" style="background: linear-gradient(135deg, #5D69BE 0%, #43389F 100%);">
                            <div class="card-body text-center py-4">
                                <i class="fas fa-coins fa-2x mb-2 text-white"></i>
                                <h3 id="totalAnalyzed" class="mb-1 text-white font-weight-bold">-</h3>
                                <small class="text-white-75 fw-bold">분석된 코인</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-gradient border-0 h-100 summary-card" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF4848 100%);">
                            <div class="card-body text-center py-4">
                                <i class="fas fa-star fa-2x mb-2 text-white"></i>
                                <h3 id="recommendedCount" class="mb-1 text-white font-weight-bold">-</h3>
                                <small class="text-white-75 fw-bold">추천 코인</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-gradient border-0 h-100 summary-card" style="background: linear-gradient(135deg, #20BF55 0%, #01BAEF 100%);">
                            <div class="card-body text-center py-4">
                                <i class="fas fa-chart-line fa-2x mb-2 text-white"></i>
                                <h3 id="avgScore" class="mb-1 text-white font-weight-bold">-</h3>
                                <small class="text-white-75 fw-bold">평균 점수</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-gradient border-0 h-100 summary-card" style="background: linear-gradient(135deg, #FF9A8B 0%, #FF6B88 100%);">
                            <div class="card-body text-center py-4">
                                <i class="fas fa-clock fa-2x mb-2 text-white"></i>
                                <h3 id="lastUpdate" class="mb-1 text-white font-weight-bold">-</h3>
                                <small class="text-white-75 fw-bold">업데이트</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 추천 코인 목록 -->
                <div id="recommendationsContainer">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 py-3">
                            <h5 class="mb-0 text-dark fw-bold">
                                <i class="fas fa-trophy text-warning me-2"></i>추천 코인 랭킹
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table id="recommendationsTable" class="table table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th class="text-center" style="width: 60px;">순위</th>
                                            <th style="min-width: 120px;">코인</th>
                                            <th class="text-end" style="width: 100px;">현재가</th>
                                            <th class="text-center" style="width: 120px;">종합점수</th>
                                            <th class="text-center" style="width: 100px;">추천등급</th>
                                            <th class="text-center" style="width: 80px;">위험도</th>
                                            <th class="text-end" style="width: 80px;">24h 수익률</th>
                                            <th class="text-center" style="width: 70px;">기술</th>
                                            <th class="text-center" style="width: 70px;">거래량</th>
                                            <th class="text-center" style="width: 70px;">변동성</th>
                                            <th class="text-center" style="width: 80px;">상세</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recommendationsBody">
                                        <!-- 초기 로딩 메시지 -->
                                        <tr id="initialLoadingRow">
                                            <td colspan="11" class="text-center py-5">
                                                <div class="text-muted">
                                                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                                    <h6>데이터를 불러오는 중입니다...</h6>
                                                    <p class="mb-0">잠시만 기다려주세요</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 에러 메시지 -->
                <div id="errorContainer" class="alert alert-danger border-0 shadow-sm mt-3" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-2">오류 발생</h5>
                            <p id="errorMessage" class="mb-0"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 상세 분석 모달 -->
<div class="modal fade" id="coinDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 bg-primary text-white">
                <h5 class="modal-title fw-bold" id="modalTitle">
                    <i class="fas fa-search-dollar me-2"></i>코인 상세 분석
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4" id="modalBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" style="width: 2.5rem; height: 2.5rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h6 class="text-primary">상세 분석 중...</h6>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>닫기
                </button>
                <a id="tradingBtn" href="#" class="btn btn-success">
                    <i class="fas fa-chart-line me-2"></i>매매하기
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 커스텀 CSS -->
<style>
.main-content-area {
    min-height: 600px;
}

.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
}

/* 요약 카드 스타일 개선 */
.summary-card {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border-radius: 12px !important;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.summary-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.summary-card .card-body {
    position: relative;
    z-index: 2;
}

.summary-card h3 {
    font-size: 2.5rem !important;
    font-weight: 800 !important;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    color: #ffffff !important;
}

.summary-card i {
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    color: #ffffff !important;
}

.summary-card small {
    font-size: 0.9rem;
    font-weight: 600;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    color: #ffffff !important;
    opacity: 0.95;
}

/* 텍스트 가시성 강화 클래스 */
.text-white-75 {
    color: rgba(255, 255, 255, 0.95) !important;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.font-weight-bold {
    font-weight: 800 !important;
}

/* 대체 색상 방안 - 필요시 사용 */
.summary-card-alt {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
    color: #ffffff !important;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.summary-card-alt h3,
.summary-card-alt i,
.summary-card-alt small {
    color: #ffffff !important;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}

.progress {
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
}

.badge {
    font-size: 0.8rem;
}

.table th {
    font-weight: 600;
    font-size: 0.9rem;
}

.table td {
    vertical-align: middle;
    font-size: 0.9rem;
}

#loadingOverlay {
    border-radius: 0.375rem;
}

.spinner-border {
    animation: spinner-border 1.5s linear infinite;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fadeIn 0.5s ease forwards;
}

/* 반응형 디자인 */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.85rem;
    }

    .card-body.py-4 {
        padding: 1rem !important;
    }

    .modal-xl {
        max-width: 95%;
    }

    .summary-card h3 {
        font-size: 2rem !important;
    }

    .summary-card i {
        font-size: 1.5rem !important;
    }
}

/* 다크 모드 대응 (필요시) */
@media (prefers-color-scheme: dark) {
    .summary-card h3,
    .summary-card i,
    .summary-card small {
        color: #ffffff !important;
        text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);
    }
}
</style>

<script>
let autoRefreshInterval;
let lastUpdateTime = null;
let loadingInProgress = false;
let currentData = [];

document.addEventListener('DOMContentLoaded', function() {
    // 초기 데이터 로드
    loadRecommendations();

    // 텍스트 가시성 즉시 적용
    setTimeout(() => {
        const summaryCards = document.querySelectorAll('.summary-card');
        summaryCards.forEach(card => {
            const textElements = card.querySelectorAll('h3, small, i');
            textElements.forEach(element => {
                element.style.color = '#ffffff !important';
                element.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5)';
                element.style.fontWeight = element.tagName === 'H3' ? '800' : 'inherit';
            });
        });
    }, 100);

    // 디바운스된 이벤트 리스너
    const debouncedLoad = debounce(loadRecommendations, 500);

    document.getElementById('refreshBtn').addEventListener('click', loadRecommendations);
    document.getElementById('marketAnalysisBtn').addEventListener('click', showMarketAnalysis);
    document.getElementById('limitSelect').addEventListener('change', debouncedLoad);
    document.getElementById('minScoreSelect').addEventListener('change', debouncedLoad);
    document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);
});

// 디바운스 함수
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function updateStatus(status, type = 'secondary') {
    const indicator = document.getElementById('statusIndicator');
    indicator.textContent = status;
    indicator.className = `badge bg-${type}`;
}

function showLoadingOverlay() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = 'flex';
    requestAnimationFrame(() => {
        overlay.style.opacity = '1';
    });
}

function hideLoadingOverlay() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.opacity = '0';
    setTimeout(() => {
        overlay.style.display = 'none';
    }, 300);
}

function loadRecommendations() {
    if (loadingInProgress) {
        console.log('이미 로딩 중입니다.');
        return;
    }

    const limit = document.getElementById('limitSelect').value;
    const minScore = document.getElementById('minScoreSelect').value;

    loadingInProgress = true;
    updateStatus('분석 중...', 'warning');

    if (!currentData.length) {
        showLoadingOverlay();
    }

    document.getElementById('errorContainer').style.display = 'none';

    const refreshBtn = document.getElementById('refreshBtn');
    const originalBtnState = {
        disabled: refreshBtn.disabled,
        innerHTML: refreshBtn.innerHTML
    };

    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>분석 중...';

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 120000); // 2분으로 연장

    fetch(`/api/coin_recommendations?limit=${limit}&min_score=${minScore}`, {
        signal: controller.signal,
        headers: {
            'Cache-Control': 'no-cache',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // 표준화된 API 응답 구조에 맞게 데이터 추출
                const recommendationsData = data.data.recommendations || data.data || [];
                currentData = recommendationsData;
                displayRecommendations(recommendationsData);
                updateSummary(data);
                updateStatus('완료', 'success');
                lastUpdateTime = new Date();
            } else {
                showError(data.error || '추천 데이터를 가져오는데 실패했습니다.');
                updateStatus('오류', 'danger');
            }
        })
        .catch(error => {
            console.error('API 요청 오류:', error);

            if (error.name === 'AbortError') {
                showError('요청 시간이 초과되었습니다. 다시 시도해주세요.');
            } else {
                showError('네트워크 오류: ' + error.message);
            }
            updateStatus('연결 오류', 'danger');
        })
        .finally(() => {
            clearTimeout(timeoutId);
            loadingInProgress = false;
            hideLoadingOverlay();

            refreshBtn.disabled = originalBtnState.disabled;
            refreshBtn.innerHTML = originalBtnState.innerHTML;
        });
}

function displayRecommendations(recommendations) {
    const tbody = document.getElementById('recommendationsBody');

    const initialRow = document.getElementById('initialLoadingRow');
    if (initialRow) {
        initialRow.remove();
    }

    if (recommendations.length === 0) {
        tbody.innerHTML = `
            <tr class="animate-fade-in">
                <td colspan="11" class="text-center py-5">
                    <div class="text-muted">
                        <i class="fas fa-search fa-2x mb-3"></i>
                        <h6>조건에 맞는 추천 코인이 없습니다</h6>
                        <p class="mb-0">필터 조건을 조정해보세요</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    const fragment = document.createDocumentFragment();

    recommendations.forEach((coin, index) => {
        const row = createCoinRow(coin, index);
        fragment.appendChild(row);
    });

    tbody.innerHTML = '';
    tbody.appendChild(fragment);
}

function createCoinRow(coin, index) {
    const row = document.createElement('tr');
    row.className = 'align-middle animate-fade-in';
    row.style.animationDelay = `${Math.min(index * 0.05, 1)}s`;

    const rankIcon = getRankIcon(index);
    const current_price = formatPrice(coin.current_price);
    const return_24h = coin.performance.return_24h;
    const return_class = return_24h >= 0 ? 'text-success' : 'text-danger';
    const return_sign = return_24h > 0 ? '+' : '';

    row.innerHTML = `
        <td class="text-center">${rankIcon}</td>
        <td>
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                         style="width: 40px; height: 40px; font-size: 12px; color: white; font-weight: bold;">
                        ${coin.name.substring(0, 3).toUpperCase()}
                    </div>
                </div>
                <div>
                    <div class="fw-bold">${coin.name}</div>
                    <small class="text-muted">${coin.ticker}</small>
                </div>
            </div>
        </td>
        <td class="text-end"><span class="fw-semibold">${current_price}</span></td>
        <td class="text-center">
            <div class="d-flex flex-column align-items-center">
                <div class="progress mb-1" style="width: 60px; height: 8px;">
                    <div class="progress-bar ${getScoreColor(coin.score)}" style="width: ${coin.score}%"></div>
                </div>
                <small class="fw-bold ${getScoreTextColor(coin.score)}">${coin.score}</small>
            </div>
        </td>
        <td class="text-center">
            <span class="badge ${getRecommendationBadge(coin.recommendation)} px-3 py-2">${coin.recommendation}</span>
        </td>
        <td class="text-center">
            <span class="badge ${getRiskBadge(coin.risk_level)}">${coin.risk_level}</span>
        </td>
        <td class="text-end">
            <span class="fw-bold ${return_class}">${return_sign}${return_24h.toFixed(2)}%</span>
        </td>
        <td class="text-center"><div class="badge bg-light text-dark">${coin.technical_score}</div></td>
        <td class="text-center"><div class="badge bg-light text-dark">${coin.volume_score}</div></td>
        <td class="text-center"><div class="badge bg-light text-dark">${coin.volatility_score}</div></td>
        <td class="text-center">
            <button class="btn btn-outline-primary btn-sm" onclick="showDetailAnalysis('${coin.ticker}')" title="상세 분석 보기">
                <i class="fas fa-chart-bar"></i>
            </button>
        </td>
    `;

    return row;
}

function getRankIcon(index) {
    const rankIcons = {
        0: '<i class="fas fa-medal text-warning"></i>',
        1: '<i class="fas fa-medal" style="color: #C0C0C0;"></i>',
        2: '<i class="fas fa-medal" style="color: #CD7F32;"></i>'
    };

    return rankIcons[index] || `<span class="badge bg-light text-dark">${index + 1}</span>`;
}

function updateSummary(data) {
    const now = new Date();

    // 표준화된 API 응답에서 데이터 추출
    const totalAnalyzed = data.data.count || data.data.total_analyzed || 0;
    const recommendations = data.data.recommendations || data.data || [];
    const recommendedCount = Array.isArray(recommendations) ? recommendations.length : 0;

    const totalAnalyzedElement = document.getElementById('totalAnalyzed');
    const recommendedCountElement = document.getElementById('recommendedCount');
    const avgScoreElement = document.getElementById('avgScore');
    const lastUpdateElement = document.getElementById('lastUpdate');

    if (totalAnalyzedElement) {
        totalAnalyzedElement.textContent = totalAnalyzed.toLocaleString();
        totalAnalyzedElement.style.color = '#ffffff !important';
        totalAnalyzedElement.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5)';
    }

    if (recommendedCountElement) {
        recommendedCountElement.textContent = recommendedCount.toLocaleString();
        recommendedCountElement.style.color = '#ffffff !important';
        recommendedCountElement.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5)';
    }

    if (avgScoreElement) {
        if (recommendations && recommendations.length > 0) {
            const avgScore = recommendations.reduce((sum, coin) => sum + (coin.score || 0), 0) / recommendations.length;
            avgScoreElement.textContent = avgScore.toFixed(1);
        } else {
            avgScoreElement.textContent = '0.0';
        }
        avgScoreElement.style.color = '#ffffff !important';
        avgScoreElement.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5)';
    }

    if (lastUpdateElement) {
        lastUpdateElement.textContent = now.toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        lastUpdateElement.style.color = '#ffffff !important';
        lastUpdateElement.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5)';
    }

    const summaryElement = document.getElementById('analysisSummary');
    if (summaryElement) {
        if (summaryElement.style.opacity !== '1') {
            summaryElement.style.opacity = '0';
            summaryElement.style.display = 'flex';
            setTimeout(() => {
                summaryElement.style.opacity = '1';
                summaryElement.style.transition = 'opacity 0.5s ease-in-out';
            }, 100);
        }

        const textElements = summaryElement.querySelectorAll('h3, small, i');
        textElements.forEach(element => {
            element.style.color = '#ffffff !important';
            element.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5)';
        });
    }
}

function showDetailAnalysis(ticker) {
    console.log('상세 분석 시작:', ticker);

    const modal = new bootstrap.Modal(document.getElementById('coinDetailModal'));
    document.getElementById('modalTitle').innerHTML = `
        <i class="fas fa-search-dollar me-2"></i>${ticker} 상세 분석
    `;
    document.getElementById('modalBody').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary mb-3" style="width: 2.5rem; height: 2.5rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h6 class="text-primary">상세 분석 중...</h6>
        </div>
    `;

    document.getElementById('tradingBtn').href = `/settings?ticker=${ticker}`;

    modal.show();

    const apiUrl = `/api/coin_analysis/${ticker}`;
    console.log('API 호출 URL:', apiUrl);

    fetch(apiUrl)
        .then(response => {
            console.log('API 응답 상태:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API 응답 데이터:', data);
            if (data.success) {
                // 표준화된 API 응답에서 분석 데이터 추출
                const analysisData = data.data.analysis || data.data;
                displayDetailAnalysis(analysisData);
            } else {
                console.error('API 오류:', data.error);
                document.getElementById('modalBody').innerHTML = `
                    <div class="alert alert-danger border-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        분석 데이터를 가져올 수 없습니다: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('네트워크 오류:', error);
            document.getElementById('modalBody').innerHTML = `
                <div class="alert alert-danger border-0">
                    <i class="fas fa-wifi me-2"></i>
                    네트워크 오류: ${error.message}
                </div>
            `;
        });
}

function displayDetailAnalysis(analysis) {
    const performance = analysis.performance || {};
    const modalBody = document.getElementById('modalBody');

    modalBody.innerHTML = `
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card border-0 bg-light h-100">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>기본 정보</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-0">
                            <tr>
                                <td class="border-0 fw-semibold">현재가</td>
                                <td class="border-0 text-end fw-bold">${formatPrice(analysis.current_price)}</td>
                            </tr>
                            <tr>
                                <td class="border-0 fw-semibold">종합점수</td>
                                <td class="border-0 text-end">
                                    <span class="badge ${getScoreColor(analysis.score)} px-3 py-2">${analysis.score}</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="border-0 fw-semibold">추천등급</td>
                                <td class="border-0 text-end">
                                    <span class="badge ${getRecommendationBadge(analysis.recommendation)} px-3 py-2">${analysis.recommendation}</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="border-0 fw-semibold">위험도</td>
                                <td class="border-0 text-end">
                                    <span class="badge ${getRiskBadge(analysis.risk_level)}">${analysis.risk_level}</span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card border-0 bg-light h-100">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>수익률 정보</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-0">
                            <tr>
                                <td class="border-0 fw-semibold">1시간</td>
                                <td class="border-0 text-end fw-bold ${performance.return_1h >= 0 ? 'text-success' : 'text-danger'}">
                                    ${performance.return_1h > 0 ? '+' : ''}${(performance.return_1h || 0).toFixed(2)}%
                                </td>
                            </tr>
                            <tr>
                                <td class="border-0 fw-semibold">4시간</td>
                                <td class="border-0 text-end fw-bold ${performance.return_4h >= 0 ? 'text-success' : 'text-danger'}">
                                    ${performance.return_4h > 0 ? '+' : ''}${(performance.return_4h || 0).toFixed(2)}%
                                </td>
                            </tr>
                            <tr>
                                <td class="border-0 fw-semibold">24시간</td>
                                <td class="border-0 text-end fw-bold ${performance.return_24h >= 0 ? 'text-success' : 'text-danger'}">
                                    ${performance.return_24h > 0 ? '+' : ''}${(performance.return_24h || 0).toFixed(2)}%
                                </td>
                            </tr>
                            ${performance.return_1w ? `
                            <tr>
                                <td class="border-0 fw-semibold">1주일</td>
                                <td class="border-0 text-end fw-bold ${performance.return_1w >= 0 ? 'text-success' : 'text-danger'}">
                                    ${performance.return_1w > 0 ? '+' : ''}${performance.return_1w.toFixed(2)}%
                                </td>
                            </tr>
                            ` : ''}
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <h6 class="text-primary fw-bold mb-3">
                    <i class="fas fa-microscope me-2"></i>분석 점수 상세
                </h6>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card border-0 text-center h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <div class="card-body py-4">
                                <i class="fas fa-chart-area fa-2x mb-3"></i>
                                <h4 class="fw-bold">${analysis.technical_score}</h4>
                                <small class="opacity-75">기술적 분석</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card border-0 text-center h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                            <div class="card-body py-4">
                                <i class="fas fa-chart-bar fa-2x mb-3"></i>
                                <h4 class="fw-bold">${analysis.volume_score}</h4>
                                <small class="opacity-75">거래량 분석</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card border-0 text-center h-100" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                            <div class="card-body py-4">
                                <i class="fas fa-wave-square fa-2x mb-3"></i>
                                <h4 class="fw-bold">${analysis.volatility_score}</h4>
                                <small class="opacity-75">변동성 분석</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        ${performance.trade_value_24h ? `
        <div class="row">
            <div class="col-12">
                <div class="card border-0 bg-light">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>거래 정보</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-0">
                            <tr>
                                <td class="border-0 fw-semibold">24시간 거래대금</td>
                                <td class="border-0 text-end fw-bold">${formatPrice(performance.trade_value_24h)}</td>
                            </tr>
                            <tr>
                                <td class="border-0 fw-semibold">24시간 거래량</td>
                                <td class="border-0 text-end fw-bold">${formatVolume(performance.volume_24h)}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
    `;
}

function showMarketAnalysis() {
    const btn = document.getElementById('marketAnalysisBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>분석 중...';
    btn.disabled = true;

    fetch('/api/market_analysis')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 표준화된 API 응답에서 시장 분석 데이터 추출
                const marketData = data.data.market_analysis || data.data;
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success border-0 shadow-sm alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle fa-2x text-success me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">시장 분석 완료!</h6>
                            <p class="mb-0">분석된 코인: <strong>${marketData.total_analyzed || 0}개</strong> |
                            분석 시간: <strong>${new Date(data.data.analysis_time || Date.now()).toLocaleString('ko-KR')}</strong></p>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);

                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);

                setTimeout(() => {
                    loadRecommendations();
                }, 1000);
            } else {
                showError('시장 분석에 실패했습니다: ' + data.error);
            }
        })
        .catch(error => {
            showError('네트워크 오류: ' + error.message);
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function toggleAutoRefresh() {
    const checkbox = document.getElementById('autoRefresh');

    if (checkbox.checked) {
        if (!document.hidden) {
            autoRefreshInterval = setInterval(() => {
                if (!document.hidden && !loadingInProgress) {
                    loadRecommendations();
                }
            }, 5 * 60 * 1000);
        }
        updateStatus('자동 새로고침 중', 'info');
    } else {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
        updateStatus('수동', 'secondary');
    }
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorContainer').style.display = 'block';
    const errorContainer = document.getElementById('errorContainer');
    errorContainer.classList.add('animate-fade-in');
}

// 유틸리티 함수들
function formatPrice(price) {
    if (price >= 1000) {
        return price.toLocaleString('ko-KR') + '원';
    } else {
        return price.toFixed(2) + '원';
    }
}

function formatVolume(volume) {
    if (volume >= 1000000000) {
        return (volume / 1000000000).toFixed(1) + 'B';
    } else if (volume >= 1000000) {
        return (volume / 1000000).toFixed(1) + 'M';
    } else if (volume >= 1000) {
        return (volume / 1000).toFixed(1) + 'K';
    } else {
        return volume.toFixed(2);
    }
}

function getScoreColor(score) {
    if (score >= 80) return 'bg-success';
    if (score >= 70) return 'bg-info';
    if (score >= 60) return 'bg-warning';
    if (score >= 40) return 'bg-secondary';
    if (score >= 20) return 'bg-danger';
    return 'bg-dark';
}

function getScoreTextColor(score) {
    if (score >= 70) return 'text-success';
    if (score >= 50) return 'text-info';
    if (score >= 30) return 'text-warning';
    return 'text-danger';
}

function getRecommendationBadge(recommendation) {
    const badges = {
        '강력매수': 'bg-success',
        '매수': 'bg-primary',
        '약간매수': 'bg-info',
        '보유': 'bg-secondary',
        '약간매도': 'bg-warning text-dark',
        '매도': 'bg-danger'
    };
    return badges[recommendation] || 'bg-secondary';
}

function getRiskBadge(riskLevel) {
    const badges = {
        '낮음': 'bg-success',
        '보통': 'bg-warning text-dark',
        '높음': 'bg-danger',
        '매우높음': 'bg-dark'
    };
    return badges[riskLevel] || 'bg-secondary';
}

// 페이지 언로드 시 자동 새로고침 정리
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
});

// 페이지 가시성 변경 시 자동 새로고침 일시정지/재개
document.addEventListener('visibilitychange', function() {
    const checkbox = document.getElementById('autoRefresh');

    if (document.hidden && autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    } else if (!document.hidden && checkbox.checked && !autoRefreshInterval) {
        autoRefreshInterval = setInterval(() => {
            if (!document.hidden && !loadingInProgress) {
                loadRecommendations();
            }
        }, 5 * 60 * 1000);
    }
});

// 에러 처리 개선
window.addEventListener('error', function(event) {
    console.error('JavaScript 오류:', event.error);
    showError('페이지에서 오류가 발생했습니다. 새로고침을 시도해보세요.');
});

window.addEventListener('unhandledrejection', function(event) {
    console.error('처리되지 않은 Promise 거부:', event.reason);
    showError('네트워크 연결 문제가 발생했습니다. 잠시 후 다시 시도해주세요.');
});
</script>
{% endblock %}